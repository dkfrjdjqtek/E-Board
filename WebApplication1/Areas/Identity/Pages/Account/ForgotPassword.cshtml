@page
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResource> S
@model WebApplication1.Areas.Identity.Pages.Account.ForgotPasswordModel
@{
    ViewData["Title"] = S["FP_Title"];

    /* 2025.09.17 Added: 서버 ModelState를 { 키: [메시지] } 맵으로 변환하여 EBValidate에 전달 */
    var errMap = ViewData.ModelState
        .Where(kv => kv.Value?.Errors?.Count > 0)
        .ToDictionary(
            kv => kv.Key,
            kv => kv.Value!.Errors.Select(e => e.ErrorMessage).ToArray()
        );
    var serverErrors = errMap.Values.SelectMany(v => v).ToArray();
}

<h1>@S["FP_Title"]</h1>

@* 2025.09.17 Added: 요약은 공통 파셜로 통일 id는 fp-alert *@
@await Html.PartialAsync(
        "~/Views/Shared/_ValidationAlert.cshtml",
        serverErrors,
        new ViewDataDictionary(ViewData) { ["AlertId"] = "fp-alert" }
    )

<form method="post" id="fp-form" novalidate>
    @Html.AntiForgeryToken()

    <div class="mb-3">
        <label asp-for="Input.UserName" class="form-label"></label>
        <input asp-for="Input.UserName"
               class="form-control"
               autocomplete="username"
               placeholder="@S["FP_UserName_Placeholder"]" />
        @* 2025.09.17 Removed: 필드 개별 span은 EBValidate가 생성하므로 제거 *@
        @* <span asp-validation-for="Input.UserName" class="text-danger"></span> *@
    </div>

    <div class="mb-3">
        <label asp-for="Input.Email" class="form-label"></label>
        <input asp-for="Input.Email"
               class="form-control"
               autocomplete="email"
               placeholder="@S["FP_Email_Placeholder"]" />
        @* 2025.09.17 Removed: 필드 개별 span은 EBValidate가 생성하므로 제거 *@
        @* <span asp-validation-for="Input.Email" class="text-danger"></span> *@
    </div>

    <button type="submit" class="btn btn-primary w-100 py-2">
        @S["FP_SendButton"]
    </button>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        /* 2025.09.17 Added: 서버 에러를 클라이언트로 전달 */
        window.__FP_ERRMAP__ = @System.Text.Json.JsonSerializer.Serialize(errMap);

        (function () {
            var formSel = '#fp-form';
            var alertId = 'fp-alert';

            // 2025.09.17 Added: EBValidate 바인딩 한 곳에서 상태 통일
            if (window.EBValidate && document.querySelector(formSel)) {
                EBValidate.bindForm(formSel, { alertId: alertId });
            }

            // 2025.09.17 Added: 서버 에러가 있으면 요약 고정 및 필드 invalid 표시 잠금
            var map = window.__FP_ERRMAP__ || {};
            var all = Object.values(map).flat();
            if (all.length && window.EBValidate) {
                EBValidate.showAlert(alertId, all);

                Object.keys(map).forEach(function (k) {
                    // Razor id 규칙: . → _
                    var id = k.replace(/\./g, '_'); // ex) Input.UserName → Input_UserName
                    var el = document.getElementById(id);
                    if (el) EBValidate.setInvalid(el, (map[k] && map[k][0]) || '');
                });
            }
        })();
    </script>
}
