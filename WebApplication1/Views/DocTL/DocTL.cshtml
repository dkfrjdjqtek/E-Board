@* Views/DocTL/DocTL.cshtml *@
@model WebApplication1.Models.DocTLViewModel
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> S
@{
    ViewData["Title"] = S["DTL_Title_DocManage"];
    var isAdmin = (bool)(ViewBag.IsAdmin ?? false);
}
<style>
    .flex-eq {
        flex: 1 0 0;
        min-width: 0
    }

    .table thead th {
        white-space: nowrap
    }

    .input-group.input-group-sm > .form-select {
        height: calc(1.5em + .5rem + 2px)
    }

    .input-group.input-group-sm > .btn {
        height: calc(1.5em + .5rem + 2px)
    }

    .input-group > .form-select + .btn {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0
    }
</style>

<div class="container-fluid py-3">
    <div class="d-flex flex-wrap align-items-end gap-2 mb-3">
        <div>
            <label class="form-label mb-1">@S["DTL_Label_Site"]</label>
            <select id="compSelect" class="form-select form-select-sm" name="SelectedCompCd" @(isAdmin ? "" : "disabled")>
                @foreach (var it in Model.CompOptions)
                {
                    <option value="@it.Value" selected="@(it.Selected ? "selected" : null)">@it.Text</option>
                }
            </select>
        </div>

        <div>
            <label class="form-label mb-1">@S["DTL_Label_Dept"]</label>
            <select id="deptSelect" class="form-select form-select-sm" name="SelectedDepartmentId">
                @foreach (var it in Model.DepartmentOptions)
                {
                    <option value="@it.Value" selected="@(it.Selected ? "selected" : null)">@it.Text</option>
                }
            </select>
        </div>

        <div class="d-flex flex-grow-1 gap-2" style="min-width:360px;">
            <div class="flex-eq">
                <label class="form-label mb-1">@S["DTL_Label_Kind"]</label>
                <select id="kindSelect" class="form-select form-select-sm"></select>
            </div>
            <div class="flex-eq">
                <label class="form-label mb-1">@S["DTL_Label_DocName"]</label>
                <select id="docSelect" class="form-select form-select-sm" name="SelectedDocumentCode">
                    @foreach (var it in Model.DocumentOptions)
                    {
                        <option value="@it.Value">@it.Text</option>
                    }
                </select>
            </div>
        </div>

        <div class="d-flex align-items-end gap-2 ms-auto" style="width:360px;">
            <a id="btnLoad" class="btn btn-secondary btn-sm flex-eq" href="javascript:void(0)">@S["DTL_Btn_Load"]</a>
            <a id="btnNewTemplate"
               class="btn btn-primary btn-sm flex-eq"
               href="#"
               data-bs-toggle="modal"
               data-bs-target="#newTemplateModal">@S["DTL_Btn_NewTemplate"]</a>
        </div>
    </div>

    <div id="docArea"></div>
</div>

<!-- New Template Modal -->
<div class="modal fade" id="newTemplateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@S["DTL_Title_NewTemplate"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="frmNewTemplate" method="post" enctype="multipart/form-data" action="/DocumentTemplates/new-template" novalidate>
                @Html.AntiForgeryToken()
                <input type="hidden" name="compCd" id="nt-compCd" />
                <div class="modal-body">

                    @* ▼▼▼ 기존 직접 작성한 경고 DIV는 주석 처리합니다. (공통 부분뷰 사용) *@
                    @* <div id="nt-alert" class="alert alert-danger d-none mb-3" role="alert"></div> *@

                    @* ★ 공통 경고 박스: 서버측 ModelState 에러도 같은 컨테이너(#nt-alert)에 표시됩니다. *@
                    @{
                        var serverErrors = ViewData.ModelState.IsValid
                        ? Enumerable.Empty<string>()
                        : ViewData.ModelState.Values.SelectMany(v => v.Errors).Select(e => e.ErrorMessage);
                    }
                    @await Html.PartialAsync(
                             "_ValidationAlert",
                             serverErrors,
                             new ViewDataDictionary(ViewData) { ["AlertId"] = "nt-alert" }  // ← 컨테이너 id
                             )

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label mb-1">@S["DTL_Label_Site"]</label>
                            <select id="nt-compSel" class="form-select form-select-sm" @(isAdmin ? "" : "disabled")></select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label mb-1">@S["DTL_Label_Dept"]</label>
                            <select id="nt-deptSel" name="departmentId" class="form-select form-select-sm"></select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label mb-1">@S["DTL_Label_Kind"]</label>
                            <div class="input-group input-group-sm align-items-stretch">
                                <select id="nt-kindSel" name="kind" class="form-select form-select-sm"></select>
                                <button type="button" id="btnKindAddToggle" class="btn btn-outline-secondary">@S["_CM_Add"]</button>
                            </div>
                        </div>

                        <!-- 새 범주 추가 -->
                        <div class="col-12 d-none" id="kindAddBox">
                            <div class="border rounded p-3">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <label class="form-label mb-1">@S["DTL_Label_Site"]</label>
                                        <select id="ntk-compSel" class="form-select form-select-sm" @(isAdmin ? "" : "disabled")></select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label mb-1">@S["DTL_Label_Dept"]</label>
                                        <select id="ntk-deptSel" class="form-select form-select-sm"></select>
                                    </div>
                                </div>
                                <div class="row g-2 mt-2">
                                    <div class="col-md-6"><input id="ntk-name-ko" class="form-control form-control-sm" placeholder="한글" /></div>
                                    <div class="col-md-6"><input id="ntk-name-en" class="form-control form-control-sm" placeholder="English" /></div>
                                    <div class="col-md-6"><input id="ntk-name-vi" class="form-control form-control-sm" placeholder="Tiếng Việt" /></div>
                                    <div class="col-md-6"><input id="ntk-name-id" class="form-control form-control-sm" placeholder="Bahasa Indonesia" /></div>
                                    <div class="col-md-6"><input id="ntk-name-zh" class="form-control form-control-sm" placeholder="中文" /></div>
                                </div>
                                <div class="mt-2 d-grid w-100" style="grid-template-columns: 1fr 1fr; gap:.5rem;">
                                    <button type="button" id="btnKindSave" class="btn btn-primary btn-sm w-100">@S["DTL_Btn_AddCategory"]</button>
                                    <button type="button" id="btnKindCancel" class="btn btn-outline-secondary btn-sm w-100">@S["_CM_Close"]</button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label mb-1">@S["DTL_Label_DocName"]</label>
                            <input id="nt-docName" type="text" name="docName" class="form-control form-control-sm" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label mb-1">@S["DTL_Label_Excel"]</label>
                            <div class="input-group input-group-sm">
                                <input id="nt-excel" type="file" name="excelFile" class="d-none" accept=".xlsx,.xlsm" required />
                                <label for="nt-excel" class="btn btn-outline-secondary">@S["DTL_Btn_ChooseFile"]</label>
                                <input id="nt-excel-fake" type="text" class="form-control" value="@S["DTL_File_NoFile"]" readonly />
                            </div>
                            <div class="form-text">@S["DTL_Alert_ExcelOpenXmlOnly"]</div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <div class="d-grid w-100" style="grid-template-columns: 1fr 1fr; gap:.5rem;">
                        <button type="submit" class="btn btn-primary btn-sm w-100">@S["DTL_Btn_CreateTemplate"]</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm w-100" data-bs-dismiss="modal">@S["_CM_Close"]</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <!-- 전역 i18n -->
    <script>
        (function () {
            window.L = {
                ALL: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(S["_CM_All"].Value)),
                NO_FILE: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(S["DTL_File_NoFile"].Value)),
                ALERT_SELECT: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(S["_Alert_TemplateCategory_Required"].Value)),
                ALERT_SITE: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(S["_Alert_Site_Required"].Value)),
                ALERT_DOCNAME: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(S["DTL_Alert_EnterDocName"].Value)),
                ALERT_XLS_REQ: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(S["DTL_Alert_ExcelRequired"].Value)),
                ALERT_OPENXML: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(S["DTL_Alert_ExcelOpenXmlOnly"].Value)),
                SELECT: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(S["_CM_Select"].Value)),
                ADD_KIND: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(S["_CM_Add"]?.Value ?? "＋ 새 종류 추가…")),
                ALERT_DUP: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(S["DTL_Alert_Category_Duplicated"].Value)),
                DTL_Alert_DeptRequired: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(S["DTL_Alert_DeptRequired"].Value)),
                DTL_Alert_KindNameRequire: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(S["DTL_Alert_KindNameRequire"].Value)),
                DTL_Alert_EnterCurrentLang: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(S["DTL_Alert_EnterCurrentLang"].Value))
                    };
            window.CUR_LANG = '@System.Globalization.CultureInfo.CurrentUICulture.TwoLetterISOLanguageName';
            window.MSG = {
                DEPT: window.L.DTL_Alert_DeptRequired,
                KIND: window.L.DTL_Alert_KindNameRequire,
                CUR: window.L.DTL_Alert_EnterCurrentLang
            };
        })();
    </script>

    <!-- 부모 영역 -->
    <script>
        (function () {
            const BASE = "/DocumentTemplates";
            const compSel = document.getElementById('compSelect');
            const deptSel = document.getElementById('deptSelect');
            const kindSel = document.getElementById('kindSelect');
            const docSel = document.getElementById('docSelect');
            const btnNew = document.getElementById('btnNewTemplate');
            const btnLoad = document.getElementById('btnLoad');

            async function fetchJson(url) {
                const r = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (!r.ok) throw new Error('net');
                return r.json();
            }
            function clearOptions(sel) { while (sel.options.length) sel.remove(0); }
            function addOptions(sel, items) { for (const it of (items || [])) sel.add(new Option(it.text ?? '', String(it.id ?? ''))); }
            function setSelectPlaceholder(sel) { clearOptions(sel); sel.add(new Option(L.SELECT, '__SELECT__')); }

            async function loadDepartments() {
                const compCd = compSel.value || '';
                if (!compCd) { setSelectPlaceholder(deptSel); setSelectPlaceholder(kindSel); clearOptions(docSel); updateBtnLinks(); return; }
                const data = await fetchJson(`${BASE}/get-departments?compCd=${encodeURIComponent(compCd)}`);
                clearOptions(deptSel);
                (data.items || []).forEach(it => deptSel.add(new Option(it.text ?? '', String(it.id ?? ''))));
                let target = "__SELECT__";
                if (typeof data.selectedValue !== "undefined") {
                    const want = String(data.selectedValue ?? "");
                    const has = Array.from(deptSel.options).some(o => o.value === want);
                    target = has ? want : "__SELECT__";
                }
                deptSel.value = target;
            }

            async function loadKinds() {
                const compCd = compSel.value || '';
                const deptVal = deptSel.value;
                setSelectPlaceholder(kindSel);
                if (!compCd || deptVal === '__SELECT__') { clearOptions(docSel); updateBtnLinks(); return; }
                const deptParam = (deptVal === '' ? '0' : deptVal);
                const q = new URLSearchParams({ compCd, departmentId: deptParam });
                const data = await fetchJson(`${BASE}/get-kinds?${q.toString()}`);
                addOptions(kindSel, data.items || []);
                kindSel.value = '__SELECT__';
            }

            async function loadDocuments() {
                const compCd = compSel.value || '';
                const deptVal = deptSel.value;
                const rawKind = kindSel.value;
                clearOptions(docSel);
                if (!compCd || deptVal === '__SELECT__' || rawKind === '__SELECT__') { updateBtnLinks(); return; }
                const q = new URLSearchParams({ compCd });
                if (rawKind) q.append('kind', rawKind);
                if (deptVal !== '') q.append('departmentId', deptVal);
                const data = await fetchJson(`${BASE}/get-documents?${q.toString()}`);
                addOptions(docSel, data.items || []);
                updateBtnLinks();
            }

            function updateBtnLinks() {
                const compCd = compSel.value || '';
                const deptVal = deptSel.value || '';
                const rawKind = kindSel.value || '';
                const kindVal = (rawKind === '__SELECT__') ? '' : rawKind;
                const docCode = docSel.value || '';
                const qsNew = new URLSearchParams();
                if (compCd) qsNew.append('compCd', compCd);
                if (deptVal !== '' && deptVal !== '__SELECT__') qsNew.append('departmentId', deptVal);
                if (kindVal) qsNew.append('kind', kindVal);
                btnNew.href = `/DocumentTemplates/new-template${qsNew.toString() ? '?' + qsNew.toString() : ''}`;

                if (docCode) {
                    const qsOpen = new URLSearchParams();
                    if (compCd) qsOpen.append('compCd', compCd);
                    if (deptVal !== '' && deptVal !== '__SELECT__') qsOpen.append('departmentId', deptVal);
                    if (kindVal) qsOpen.append('kind', kindVal);
                    qsOpen.append('docCode', docCode);
                    btnLoad.dataset.href = `/DocumentTemplates/open?${qsOpen.toString()}`;
                } else {
                    btnLoad.dataset.href = '';
                }
            }

            btnLoad.addEventListener('click', () => {
                const href = btnLoad.dataset.href || '';
                if (!href) { alert(L.ALERT_SELECT); return; }
                window.location.href = href;
            });

            let __booting = true;

            compSel.addEventListener('change', async () => {
                if (__booting) return;
                await loadDepartments();
                deptSel.value = '__SELECT__';   // 규칙: 상위 변경 시 하위 초기화
                await loadKinds();
                kindSel.value = '__SELECT__';
                clearOptions(docSel);
                updateBtnLinks();
            });

            deptSel.addEventListener('change', async () => {
                if (__booting) return;
                await loadKinds();
                kindSel.value = '__SELECT__';
                clearOptions(docSel);
                updateBtnLinks();
            });

            kindSel.addEventListener('change', async () => {
                await loadDocuments();
            });

            (async function init() {
                await loadDepartments();      // 초기: 사용자 부서/공용 자동선택(서버 selectedValue 사용)
                await loadKinds();
                await loadDocuments();
                updateBtnLinks();
                __booting = false;
            })();
        })();
    </script>

    <!-- 모달 영역 -->
    <script>
        (function () {
            const L = window.L || {};
            const CUR_LANG = window.CUR_LANG || "en";
            const MSG = window.MSG || {};
            const BASE = "/DocumentTemplates";

            const mEl = document.getElementById('newTemplateModal');
            if (!mEl) return;

            // ── 필드별 에러 도우미(현 파일에서 계속 사용)
            function fieldContainer(el) { return el.closest('.col-md-4, .col-md-6, .col-12') || el.parentElement; }
            function ensureFeedback(el) {
                const box = fieldContainer(el);
                let fb = box.querySelector(`.invalid-feedback[data-for="${el.id}"]`);
                if (!fb) { fb = document.createElement('div'); fb.className = 'invalid-feedback d-block'; fb.dataset.for = el.id; box.appendChild(fb); }
                return fb;
            }
            function setFieldError(el, msg) { if (!el) return; el.classList.add('is-invalid'); ensureFeedback(el).textContent = (msg || ''); }
            function clearFieldError(el) {
                if (!el) return;
                el.classList.remove('is-invalid');
                const box = fieldContainer(el);
                const fb = box.querySelector(`.invalid-feedback[data-for="${el.id}"]`);
                if (fb) fb.remove();
            }

            async function fetchJson(url) {
                const r = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (!r.ok) throw new Error('net');
                return r.json();
            }
            function copyOptions(from, to) { to.innerHTML = ''; Array.from(from.options).forEach(o => to.add(new Option(o.text, o.value, false, o.selected))); }
            function fillOptions(sel, items) { sel.innerHTML = ''; (items || []).forEach(it => sel.add(new Option(it.text ?? '', String(it.id ?? '')))); }

            async function refreshDeptFor(compCd, targetSel, preferValue) {
                const data = await fetchJson(`${BASE}/get-departments?compCd=${encodeURIComponent(compCd)}`);
                fillOptions(targetSel, data.items || []);
                let target = "__SELECT__";
                const cand = (preferValue ?? data.selectedValue);
                if (typeof cand !== "undefined") {
                    const want = String(cand ?? "");
                    const has = Array.from(targetSel.options).some(o => o.value === want);
                    target = has ? want : "__SELECT__";
                }
                targetSel.value = target;
            }

            async function loadKindsForModal(compCd, deptRaw, targetSel, preferKindCode) {
                targetSel.innerHTML = '';
                targetSel.add(new Option(L.SELECT, '__SELECT__'));
                if (!compCd) return;
                const deptParam = (deptRaw === '__SELECT__' ? null : (deptRaw === '' ? '0' : deptRaw));
                if (deptParam === null) return;

                const q = new URLSearchParams({ compCd, departmentId: deptParam });
                const data = await fetchJson(`${BASE}/get-kinds?${q.toString()}`);
                (data.items || []).forEach(it => targetSel.add(new Option(it.text ?? '', String(it.id ?? ''))));

                if (preferKindCode && Array.from(targetSel.options).some(o => o.value === preferKindCode)) {
                    targetSel.value = preferKindCode;
                } else {
                    targetSel.value = '__SELECT__';
                }
            }

            const compSel = document.getElementById('compSelect');
            const deptSel = document.getElementById('deptSelect');
            const ntCompSel = document.getElementById('nt-compSel');
            const ntDeptSel = document.getElementById('nt-deptSel');
            const ntKindSel = document.getElementById('nt-kindSel');
            const ntCompCd = document.getElementById('nt-compCd');

            const btnKindAddToggle = document.getElementById('btnKindAddToggle');
            const kindAddBox = document.getElementById('kindAddBox');
            const ntkCompSel = document.getElementById('ntk-compSel');
            const ntkDeptSel = document.getElementById('ntk-deptSel');
            const btnKindSave = document.getElementById('btnKindSave');
            const btnKindCancel = document.getElementById('btnKindCancel');

            const realFile = document.getElementById('nt-excel');
            const fakeFile = document.getElementById('nt-excel-fake');

            function clearKindAddErrorsOnly() {
                ['ntk-name-ko', 'ntk-name-en', 'ntk-name-vi', 'ntk-name-id', 'ntk-name-zh'].forEach(id => clearFieldError(document.getElementById(id)));
                clearFieldError(ntkCompSel); clearFieldError(ntkDeptSel);
            }
            function clearKindAddForm() {
                ['ko', 'en', 'vi', 'id', 'zh'].forEach(c => {
                    const el = document.getElementById(`ntk-name-${c}`);
                    if (el) { el.value = ''; clearFieldError(el); }
                });
                clearFieldError(ntkCompSel); clearFieldError(ntkDeptSel);
                EBValidate.clearAlert('nt-alert');   // ★ 공통 경고 박스 초기화
            }
            function clearAllHeaderErrors() {
                ['nt-compSel', 'nt-deptSel', 'nt-kindSel', 'nt-docName', 'nt-excel-fake', 'nt-excel']
                    .forEach(id => clearFieldError(document.getElementById(id)));
                EBValidate.clearAlert('nt-alert');     // ★ 공통 경고 박스 초기화
            }

            // 모달 열릴 때: 부모 선택값 반영 + 전체 초기화
            mEl.addEventListener('show.bs.modal', async () => {
                EBValidate.clearAlert('nt-alert');      // ★
                clearAllHeaderErrors();
                clearKindAddErrorsOnly();

                const compCd = compSel?.value || '';
                if (!compCd) {
                    EBValidate.showAlert('nt-alert', L.ALERT_SITE || '사업장을 선택하세요.'); // ★
                    return;
                }

                copyOptions(compSel, ntCompSel); ntCompSel.value = compCd; ntCompCd.value = compCd;
                await refreshDeptFor(ntCompSel.value, ntDeptSel, deptSel?.value);
                if (ntDeptSel.value === "__SELECT__") ntDeptSel.value = "";

                const parentKind = document.getElementById('kindSelect')?.value || '';
                await loadKindsForModal(ntCompSel.value, ntDeptSel.value, ntKindSel, parentKind);

                kindAddBox.classList.add('d-none'); // 접기
                clearKindAddForm();                 // 값/에러 초기화
                const dn = document.getElementById('nt-docName'); if (dn) dn.value = '';
                if (fakeFile) fakeFile.value = (L.NO_FILE || ''); if (realFile) realFile.value = '';
            });

            // 모달 닫힐 때도 잔여 오류/값 정리
            mEl.addEventListener('hidden.bs.modal', () => {
                clearAllHeaderErrors();
                clearKindAddForm();
            });

            // 토글
            btnKindAddToggle?.addEventListener('click', async () => {
                const willShow = kindAddBox.classList.contains('d-none');
                kindAddBox.classList.toggle('d-none', !willShow);
                if (willShow) {
                    copyOptions(ntCompSel, ntkCompSel); ntkCompSel.value = ntCompSel.value;
                    await refreshDeptFor(ntkCompSel.value, ntkDeptSel, ntDeptSel.value);
                    if (ntkDeptSel.value === "__SELECT__") ntkDeptSel.value = "";
                    clearKindAddForm();
                } else {
                    clearKindAddForm();
                }
            });
            btnKindCancel?.addEventListener('click', () => { kindAddBox.classList.add('d-none'); clearKindAddForm(); });

            // 상단 입력 변경 시 에러 해제
            ntCompSel?.addEventListener('change', async () => {
                await refreshDeptFor(ntCompSel.value, ntDeptSel, null);
                if (ntDeptSel.value === "__SELECT__") ntDeptSel.value = "";
                await loadKindsForModal(ntCompSel.value, ntDeptSel.value, ntKindSel);

                copyOptions(ntCompSel, ntkCompSel); ntkCompSel.value = ntCompSel.value;
                await refreshDeptFor(ntkCompSel.value, ntkDeptSel, ntDeptSel.value);
                if (ntkDeptSel.value === "__SELECT__") ntkDeptSel.value = "";
            });
            ntDeptSel?.addEventListener('change', async () => {
                await loadKindsForModal(ntCompSel.value, ntDeptSel.value, ntKindSel);
            });

            ntkCompSel?.addEventListener('change', () => clearFieldError(ntkCompSel));
            ntkDeptSel?.addEventListener('change', () => clearFieldError(ntkDeptSel));
            ['ko', 'en', 'vi', 'id', 'zh'].forEach(code => {
                document.getElementById(`ntk-name-${code}`)?.addEventListener('input', e => clearFieldError(e.target));
            });

            // 상단 폼 제출(템플릿 생성)
            document.getElementById('frmNewTemplate')?.addEventListener('submit', function (e) {
                clearAllHeaderErrors();
                const errs = [];
                const dn = document.getElementById('nt-docName');
                const fxReal = document.getElementById('nt-excel');
                const fxFake = document.getElementById('nt-excel-fake');

                if (!ntCompSel.value) { errs.push(L.ALERT_SITE); setFieldError(ntCompSel, L.ALERT_SITE); }
                if (ntDeptSel.value === '__SELECT__') { const msg = (L.DTL_Alert_DeptRequired || '부서를 선택하세요.'); errs.push(msg); setFieldError(ntDeptSel, msg); }
                if (ntKindSel.value === '__SELECT__') { const msg = (L.ALERT_SELECT || '종류를 선택하세요.'); errs.push(msg); setFieldError(ntKindSel, msg); }

                const dnVal = dn?.value?.trim();
                if (!dnVal) { errs.push(L.ALERT_DOCNAME); setFieldError(dn, L.ALERT_DOCNAME); }

                const f = fxReal?.files?.[0];
                if (!f) { errs.push(L.ALERT_XLS_REQ); setFieldError(fxFake, L.ALERT_XLS_REQ); }
                else if (!/\.xlsx$|\.xlsm$/i.test(f.name)) { errs.push(L.ALERT_OPENXML); setFieldError(fxFake, L.ALERT_OPENXML); }
                else { fxFake.value = f.name; }

                if (errs.length) {
                    e.preventDefault();
                    EBValidate.showAlert('nt-alert', errs);   // ★ 공통 경고 박스 출력
                }
            });

            function getAntiForgeryToken() {
                const el = document.querySelector('#frmNewTemplate input[name="__RequestVerificationToken"]');
                return el?.value || '';
            }

            // 범주 저장
            btnKindSave?.addEventListener('click', async () => {
                EBValidate.clearAlert('nt-alert');           // ★
                clearKindAddErrorsOnly();

                const errs = [];
                const compCd = (ntkCompSel.value || '').trim();
                const deptRaw = ntkDeptSel.value;

                if (!compCd) { errs.push(L.ALERT_SITE); setFieldError(ntkCompSel, L.ALERT_SITE); }
                if (deptRaw === '__SELECT__') { const m = (MSG.DEPT || '부서를 선택하세요.'); errs.push(m); setFieldError(ntkDeptSel, m); }

                const v = {
                    ko: (document.getElementById('ntk-name-ko')?.value || '').trim(),
                    en: (document.getElementById('ntk-name-en')?.value || '').trim(),
                    vi: (document.getElementById('ntk-name-vi')?.value || '').trim(),
                    id: (document.getElementById('ntk-name-id')?.value || '').trim(),
                    zh: (document.getElementById('ntk-name-zh')?.value || '').trim()
                };
                const anyLang = Object.values(v).some(Boolean);
                if (!anyLang) {
                    const m = (MSG.KIND || '종류 이름(최소 1개 언어)이 필요합니다.');
                    errs.push(m);
                    ['ko', 'en', 'vi', 'id', 'zh'].forEach(code => { const el = document.getElementById(`ntk-name-${code}`); el && setFieldError(el, m); });
                }
                if (!v[CUR_LANG]) {
                    const m = (MSG.CUR || '현재 언어 필드는 필수입니다.');
                    errs.push(m);
                    const elCur = document.getElementById(`ntk-name-${CUR_LANG}`); elCur && setFieldError(elCur, m);
                }

                const display = v[CUR_LANG] || v.en || v.ko;
                if (display) {
                    const dup = Array.from(ntKindSel.options).some(o => o.value && o.text.trim() === display.trim());
                    if (dup) { errs.push(L.ALERT_DUP); const elCur = document.getElementById(`ntk-name-${CUR_LANG}`); elCur && setFieldError(elCur, L.ALERT_DUP); }
                }

                if (errs.length) { EBValidate.showAlert('nt-alert', errs); return; }

                const departmentId = (deptRaw === '' ? '0' : deptRaw);
                const p = new URLSearchParams({
                    compCd, departmentId,
                    nameKo: v.ko, nameEn: v.en, nameVi: v.vi, nameId: v.id, nameZh: v.zh,
                    __RequestVerificationToken: getAntiForgeryToken()
                });

                try {
                    const res = await fetch(`${BASE}/kind-add`, {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' },
                        body: p
                    });
                    const ct = (res.headers.get('content-type') || '').toLowerCase();
                    const data = ct.includes('application/json')
                        ? await res.json()
                        : { ok: false, message: (await res.text()).replace(/<[^>]+>/g, ' ') };

                    if (!res.ok || !data || data.ok !== true) {
                        if (data && data.code === 'DUP_NAME') {
                            clearKindAddErrorsOnly(); // ★ 선행 메시지 제거
                            const fld = document.getElementById(data.field) || document.getElementById(`ntk-name-${CUR_LANG}`);
                            const msg = data.message || L.ALERT_DUP;
                            fld && setFieldError(fld, msg);
                            EBValidate.showAlert('nt-alert', msg);   // ★
                            return;
                        }
                        throw new Error((data && data.message) ? data.message : `HTTP ${res.status}`);
                    }

                    // 성공: 목록 동기화 + 입력 초기화
                    const opt = new Option(data.item.text, data.item.id, false, true);
                    ntKindSel.add(opt); ntKindSel.value = data.item.id;
                    document.getElementById('kindSelect')?.add(new Option(data.item.text, data.item.id));

                    clearKindAddForm();
                    kindAddBox.classList.add('d-none');
                    EBValidate.clearAlert('nt-alert');         // ★
                } catch (e) {
                    console.error(e);
                    EBValidate.showAlert('nt-alert', e?.message || 'Error'); // ★
                }
            });

            // 쿼리로 요청 시 자동오픈
            const sp = new URLSearchParams(location.search);
            if (sp.get('openNewTemplate') === '1') {
                document.getElementById('btnNewTemplate')?.click();
            }
        })();
    </script>
}
