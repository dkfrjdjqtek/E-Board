@* 2025.11.26 Changed DocTLMap EBPreview 공통 스크립트 기반 엑셀 미리보기 마운트 복원 및 A1 선택 연동 DescriptorPreview JSON ID 통일 프리뷰 mount 호출 추가 *@
@using System.Text.Json
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> S

@{
    // 2025.09.30 Changed: AJAX 로 진입한 경우 레이아웃 미사용으로 헤더 사라짐 방지
    var isAjax = string.Equals(Context.Request.Headers["X-Requested-With"], "XMLHttpRequest", StringComparison.OrdinalIgnoreCase);
    Layout = isAjax ? null : "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = ViewBag.TemplateTitle ?? "템플릿";
}

<style>
    .flex-eq {
        flex: 1 0 0;
        min-width: 0;
    }

    .table thead th {
        white-space: nowrap;
    }

    .cell-a1 {
        width: 14rem;
    }

    .key-input {
        min-width: 10rem;
    }

    .a1-active {
        box-shadow: 0 0 0 .2rem rgba(13,110,253,.25);
        outline: 2px solid #3b82f6;
        outline-offset: -1px;
    }

    .cell-a1 .input-group {
        max-width: 14rem;
    }

    .cell-a1 .form-control {
        max-width: 8rem;
    }

    .cell-a1 .btn {
        white-space: nowrap;
    }

    /* ===== DocTLMap 미리보기 컨테이너 ===== */
    #xlPreview {
        overflow: hidden;
        max-height: 520px;
        border: 1px solid #d1d5db;
        border-radius: .25rem;
        background: #fff;
    }

    /* Map 전용: Compose/Detail 의 #doc-scroll 를 카드 내부 스크롤로 사용
       공통 스크립트의 fixed 레이아웃 강제(top/left/right/bottom)를 막기 위해 !important 추가 */
    #doc-scroll {
        position: relative;
        max-height: 480px;
        overflow: auto;
        top: auto !important;
        left: auto !important;
        right: auto !important;
        bottom: auto !important;
    }

    #xhost .xlfb {
        border-collapse: collapse;
    }

        #xhost .xlfb td {
            border: 1px solid #e5e7eb; /* 아주 연한 기본 격자 */
            box-sizing: border-box;
        }
</style>

<div class="container-fluid py-3">
    <h5 class="mb-3">@((ViewBag.TemplateTitle as string) ?? S["DTL_Title_NewTemplate"].Value)</h5>

    @{
        var alertMsg = (TempData["Alert"] as string) ?? (ViewBag.Alert as string);
    }
    @if (!string.IsNullOrWhiteSpace(alertMsg))
    {
        <div class="alert alert-danger mb-3">@alertMsg</div>
    }

    <!-- Descriptor / Preview JSON (EBDocPreview 와 Map 양쪽에서 공통 사용) -->
    <script id="DescriptorJson" type="application/json">
        @Html.Raw((ViewData["DescriptorJson"] as string) ?? (ViewBag.DescriptorJson ?? "{}"))
    </script>
    <script id="PreviewJson" type="application/json">
        @Html.Raw((ViewData["PreviewJson"] as string) ?? (ViewBag.PreviewJson ?? "{}"))
    </script>

    <form id="mapForm" method="post" action="/DocumentTemplates/map-save">
        @Html.AntiForgeryToken()
        <input type="hidden" name="descriptor" id="descriptor">
        <input type="hidden" name="excelPath" value="@ViewBag.ExcelPath">
        <input type="hidden" name="previewJson" id="previewJson">
        <input type="hidden" name="docCode" value="@ViewBag.DocCode" />

        <div class="row g-3">
            <!-- 입력 필드 매핑 -->
            <div class="col-12 col-lg-5">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center py-2">
                        <span>@S["DTL_Section_Fields"]</span>
                        <button id="btnAddField" type="button" class="btn btn-outline-primary btn-sm">@S["_CM_Add"]</button>
                    </div>
                    <div class="card-body p-2">
                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>@S["DTL_Col_FieldKey"]</th>
                                        <th style="width:8rem">@S["DTL_Col_Type"]</th>
                                        <th class="cell-a1">@S["DTL_Col_CellA1"]</th>
                                        <th style="width:4.5rem"></th>
                                    </tr>
                                </thead>
                                <tbody id="tblFieldsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 결재란 매핑 -->
            <div class="col-12 col-lg-7">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center py-2">
                        <span>@S["DTL_Section_Approvals"]</span>
                        <button id="btnAddAppr" type="button" class="btn btn-outline-primary btn-sm">@S["_CM_Add"]</button>
                    </div>
                    <div class="card-body p-2">
                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th style="width:4rem">@S["DTL_Col_Slot"]</th>
                                        <th style="width:6rem">@S["DTL_Col_Part"]</th>
                                        <th class="cell-a1">@S["DTL_Col_CellA1"]</th>
                                        <th style="width:8rem">@S["DTL_Col_ApproverType"]</th>
                                        <th>@S["DTL_Col_AssignValue"]</th>
                                        <th style="width:4.5rem"></th>
                                    </tr>
                                </thead>
                                <tbody id="tblApprBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 엑셀 미리보기 -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header py-2">@S["DTL_Section_Preview"]</div>
                    <div class="card-body">
                        <div class="text-muted small mb-2">@S["DTL_Info_ClickToFill"]</div>

                        <!-- EBDocPreview 가 #xhost 안에 실제 엑셀 프리뷰를 렌더링 -->
                        <div id="xlPreview" class="mt-2">
                            <div id="doc-scroll">
                                <div id="xhost"></div>
                            </div>
                        </div>

                        <div class="form-text mt-2">@S["DTL_Preview_MaxNote"]</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 하단 버튼 -->
        <div class="d-flex gap-2 mt-3">
            <button id="btnSave" type="button" class="btn btn-primary flex-eq">@S["_CM_Save"]</button>
            <a class="btn btn-secondary flex-eq" href="javascript:history.back()">@S["_CM_Close"]</a>
        </div>
    </form>
</div>

@* ===== 프리뷰 공통 자산(css/js) ===== *@
<link rel="stylesheet" href="~/css/eb.doc.preview.css" asp-append-version="true" />
<script src="~/js/eb.doc.preview.common.js" asp-append-version="true"></script>

@* ===== Map 전용: A1 선택 연동(프리뷰 셀 → A1 입력) ===== *@
<script>
    (function () {
        function rcToA1(row, col) {
            row = parseInt(row || "0", 10);
            col = parseInt(col || "0", 10);
            if (!row || !col) return "";
            var c = col;
            var letters = "";
            while (c > 0) {
                var rem = (c - 1) % 26;
                letters = String.fromCharCode(65 + rem) + letters;
                c = Math.floor((c - 1) / 26);
            }
            return letters + row;
        }

        function bindA1Picker() {
            var host = document.getElementById("xhost");
            if (!host) return;

            host.addEventListener("click", function (ev) {
                var td = ev.target.closest && ev.target.closest("td");
                if (!td) return;

                var a1 = rcToA1(td.getAttribute("data-r"), td.getAttribute("data-c"));
                if (!a1) return;

                if (window.__a1 && typeof window.__a1.set === "function") {
                    try {
                        window.__a1.set(a1);
                    } catch (e) {
                        console.error("[DocTLMap] __a1.set error", e);
                    }
                }
            }, { passive: true });

            console.log("[DocTLMap] A1 picker wired");
        }

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", bindA1Picker);
        } else {
            bindA1Picker();
        }
    })();
</script>

@* ===== Map 전용: 프리뷰 마운트 호출(EBDocPreview → #xhost) ===== *@
<script>
    (function () {
        var mounted = false;

        function mountPreview() {
            if (mounted) return;
            mounted = true;

            if (!window.EBDocPreview || !window.EBDocPreview.preview) {
                console.warn("[DocTLMap] EBDocPreview or preview not ready");
                return;
            }
            var p = window.EBDocPreview.preview;
            if (!p || !p.cells || !p.cells.length) {
                console.warn("[DocTLMap] preview.cells empty");
                return;
            }

            try {
                // Map 화면은 편집 오버레이 필요 없으므로 isWrite:false
                window.EBDocPreview.mount("#xhost", p, { isWrite: false });
            } catch (e) {
                console.error("[DocTLMap] preview mount error", e);
            }
        }

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", mountPreview);
        } else {
            mountPreview();
        }
    })();
</script>

@* ===== Map 본체 JS (AJAX / 비 AJAX 공통 구조 유지, DescriptorJson/PreviewJson 기준으로만 수정) ===== *@
@if (isAjax)
{
    <script>
        (function (run) {
            if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", run);
            else run();
        })(function () {
            const L = {
                PickCell: @Html.Raw(JsonSerializer.Serialize(S["DTL_Btn_PickCell"].Value)),
                NoRows: @Html.Raw(JsonSerializer.Serialize(S["DTL_Msg_NoRows"].Value)),
                NoPreview: @Html.Raw(JsonSerializer.Serialize(S["DTL_NoPreview"].Value)),
                Delete: @Html.Raw(JsonSerializer.Serialize(S["_CM_Delete"].Value)),
                MsgKeyEmpty: @Html.Raw(JsonSerializer.Serialize(S["DTL_Msg_FieldKeyEmpty"].Value)),
                MsgKeyDup: @Html.Raw(JsonSerializer.Serialize(S["DTL_Msg_FieldKeyDup"].Value)),
                UserSearchPH: @Html.Raw(JsonSerializer.Serialize(S["DTL_User_SearchPH"].Value)),
                UserNoResult: @Html.Raw(JsonSerializer.Serialize(S["DTL_User_NoResult"].Value)),
                UserLoading: @Html.Raw(JsonSerializer.Serialize(S["DTL_User_Loading"].Value)),
                UserClear: @Html.Raw(JsonSerializer.Serialize(S["DTL_User_Clear"].Value))
            };
            const T = {
                TypeText: @Html.Raw(JsonSerializer.Serialize(S["DTL_Type_Text"].Value)),
                TypeDate: @Html.Raw(JsonSerializer.Serialize(S["DTL_Type_Date"].Value)),
                TypeNum: @Html.Raw(JsonSerializer.Serialize(S["DTL_Type_Num"].Value))
            };
            const USER_API = @Html.Raw(JsonSerializer.Serialize(Url.Action("SearchUser", "DocTL")));

            function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }
            async function fetchUsers(q, take = 20) {
                const url = new URL(USER_API, location.origin);
                if (q && q.trim()) url.searchParams.set("q", q.trim());
                url.searchParams.set("take", take);
                const r = await fetch(url.toString(), { headers: { "X-Requested-With": "XMLHttpRequest" } });
                if (!r.ok) return [];
                return await r.json();
            }
            async function fetchUserById(id) {
                if (!id) return null;
                const url = new URL(USER_API, location.origin);
                url.searchParams.set("id", id);
                const r = await fetch(url.toString(), { headers: { "X-Requested-With": "XMLHttpRequest" } });
                if (!r.ok) return null;
                const arr = await r.json();
                return Array.isArray(arr) && arr.length ? arr[0] : null;
            }

            (function () {
                const raw = (document.getElementById("DescriptorJson")?.textContent || "{}").trim();
                let desc = {}; try { desc = JSON.parse(raw); } catch { desc = {}; }
                if (!Array.isArray(desc.Fields)) desc.Fields = [];
                if (!Array.isArray(desc.Approvals)) desc.Approvals = [];

                const fieldsBody = document.getElementById("tblFieldsBody");
                const apprBody = document.getElementById("tblApprBody");

                function opt(val, text, sel) { const o = document.createElement("option"); o.value = val; o.text = text; if (sel) o.selected = true; return o; }
                window.__a1 = window.__a1 || {};

                async function buildUserSelect(selectedId) {
                    const sel = document.createElement("select");
                    sel.className = "form-select form-select-sm";
                    sel.append(opt("", "—", false));
                    let list = [];
                    try { list = await fetchUsers("", 50); } catch { list = []; }
                    list.forEach(x => sel.append(opt(x.id, x.text, x.id == selectedId)));
                    return sel;
                }

                function render() {
                    fieldsBody.innerHTML = "";
                    if (desc.Fields.length === 0) {
                        const tr = document.createElement("tr"); const td = document.createElement("td");
                        td.colSpan = 4; td.className = "text-muted"; td.textContent = L.NoRows; tr.appendChild(td); fieldsBody.appendChild(tr);
                    } else {
                        desc.Fields.forEach((f, i) => {
                            const tr = document.createElement("tr");

                            const tdKey = document.createElement("td");
                            const inpKey = document.createElement("input");
                            inpKey.className = "form-control form-control-sm key-input";
                            inpKey.placeholder = "예: Item_{n} 또는 Item_{row}";
                            inpKey.value = f.Key || "";
                            inpKey.addEventListener("input", e => { desc.Fields[i].Key = e.target.value; });
                            tdKey.appendChild(inpKey);

                            const tdType = document.createElement("td");
                            const sel = document.createElement("select");
                            sel.className = "form-select form-select-sm";
                            sel.append(opt("Text", T.TypeText, (f.Type || "Text") === "Text"));
                            sel.append(opt("Date", T.TypeDate, (f.Type || "Text") === "Date"));
                            sel.append(opt("Num", T.TypeNum, (f.Type || "Text") === "Num"));
                            sel.addEventListener("change", e => { desc.Fields[i].Type = e.target.value; });
                            tdType.appendChild(sel);

                            const tdA1 = document.createElement("td"); tdA1.className = "cell-a1";
                            const grp = document.createElement("div"); grp.className = "input-group input-group-sm";

                            const inputA1 = document.createElement("input");
                            inputA1.className = "form-control"; inputA1.placeholder = "예: C9 또는 C9:C35";
                            inputA1.value = (f.Cell && f.Cell.A1) || "";
                            inputA1.addEventListener("input", e => { desc.Fields[i].Cell = desc.Fields[i].Cell || {}; desc.Fields[i].Cell.A1 = e.target.value; });
                            inputA1.addEventListener("focus", () => {
                                window.__a1.set = (a1) => {
                                    desc.Fields[i].Cell = desc.Fields[i].Cell || {};
                                    desc.Fields[i].Cell.A1 = a1;
                                    inputA1.value = a1;
                                    inputA1.classList.add("a1-active");
                                    setTimeout(() => inputA1.classList.remove("a1-active"), 800);
                                };
                            });

                            const pickBtn = document.createElement("button");
                            pickBtn.type = "button"; pickBtn.className = "btn btn-outline-secondary d-none";
                            pickBtn.textContent = L.PickCell;
                            pickBtn.addEventListener("click", () => {
                                inputA1.focus();
                                document.getElementById("xlPreview").scrollIntoView({ behavior: "smooth", block: "start" });
                            });

                            grp.append(inputA1, pickBtn);
                            tdA1.appendChild(grp);

                            const tdAct = document.createElement("td");
                            const delBtn = document.createElement("button");
                            delBtn.type = "button";
                            delBtn.className = "btn btn-outline-danger btn-sm";
                            delBtn.textContent = L.Delete;
                            delBtn.addEventListener("click", () => { desc.Fields.splice(i, 1); render(); });
                            tdAct.appendChild(delBtn);

                            tr.append(tdKey, tdType, tdA1, tdAct);
                            fieldsBody.appendChild(tr);
                        });
                    }

                    apprBody.innerHTML = "";
                    if (desc.Approvals.length === 0) {
                        const tr = document.createElement("tr"); const td = document.createElement("td");
                        td.colSpan = 6; td.className = "text-muted"; td.textContent = L.NoRows; tr.appendChild(td); apprBody.appendChild(tr);
                    } else {
                        desc.Approvals.forEach((a, i) => {
                            a = a || {}; if (!a.Cell) a.Cell = {}; if (!a.ApproverType) a.ApproverType = "Person"; if (a.ApproverValue == null) a.ApproverValue = "";

                            const tr = document.createElement("tr");

                            const tdS = document.createElement("td");
                            const inpS = document.createElement("input");
                            inpS.type = "number"; inpS.min = "1"; inpS.className = "form-control form-control-sm";
                            inpS.value = a.Slot ?? 1; inpS.addEventListener("input", e => { desc.Approvals[i].Slot = parseInt(e.target.value || "1", 10); });
                            tdS.appendChild(inpS);

                            const tdP = document.createElement("td");
                            const inpP = document.createElement("input");
                            inpP.className = "form-control form-control-sm";
                            inpP.value = a.Part || ""; inpP.addEventListener("input", e => { desc.Approvals[i].Part = e.target.value; });
                            tdP.appendChild(inpP);

                            const tdA1 = document.createElement("td"); tdA1.className = "cell-a1";
                            const grpA1 = document.createElement("div"); grpA1.className = "input-group input-group-sm";
                            const inputA1 = document.createElement("input");
                            inputA1.className = "form-control"; inputA1.placeholder = "예: H4";
                            inputA1.value = a.Cell.A1 || "";
                            inputA1.addEventListener("input", e => {
                                desc.Approvals[i].Cell = desc.Approvals[i].Cell || {};
                                desc.Approvals[i].Cell.A1 = e.target.value;
                            });
                            inputA1.addEventListener("focus", () => {
                                window.__a1.set = (a1) => {
                                    desc.Approvals[i].Cell = desc.Approvals[i].Cell || {};
                                    desc.Approvals[i].Cell.A1 = a1;
                                    inputA1.value = a1;
                                    inputA1.classList.add("a1-active");
                                    setTimeout(() => inputA1.classList.remove("a1-active"), 800);
                                };
                            });
                            grpA1.append(inputA1);
                            tdA1.appendChild(grpA1);

                            const tdType = document.createElement("td");
                            const selType = document.createElement("select");
                            selType.className = "form-select form-select-sm";
                            [["Person", "개인(사용자)"], ["Role", "역할 코드"], ["Rule", "규칙(조건)"]].forEach(([v, l]) => {
                                const o = document.createElement("option");
                                o.value = v;
                                o.text = l;
                                if ((a.ApproverType || "Person") === v) o.selected = true;
                                selType.appendChild(o);
                            });
                            selType.addEventListener("change", e => {
                                const t = e.target.value;
                                desc.Approvals[i].ApproverType = t;
                                render();
                            });
                            tdType.appendChild(selType);

                            const tdVal = document.createElement("td");
                            if ((a.ApproverType || "Person") === "Person") {
                                const holder = document.createElement("div");
                                tdVal.appendChild(holder);
                                (async () => {
                                    const sel = await buildUserSelect(a.ApproverValue || "");
                                    sel.addEventListener("change", ev => {
                                        desc.Approvals[i].ApproverValue = ev.target.value || "";
                                    });
                                    holder.replaceChildren(sel);
                                })();
                            } else {
                                const inpVal = document.createElement("input");
                                inpVal.className = "form-control form-control-sm";
                                if ((a.ApproverType || "Person") === "Role") inpVal.placeholder = "역할 코드";
                                else inpVal.placeholder = "규칙 JSON";
                                inpVal.value = a.ApproverValue || "";
                                inpVal.addEventListener("input", e => {
                                    desc.Approvals[i].ApproverValue = e.target.value;
                                });
                                tdVal.appendChild(inpVal);
                            }

                            const tdAct = document.createElement("td");
                            const delBtn = document.createElement("button");
                            delBtn.type = "button";
                            delBtn.className = "btn btn-outline-danger btn-sm";
                            delBtn.textContent = L.Delete;
                            delBtn.addEventListener("click", () => {
                                desc.Approvals.splice(i, 1);
                                render();
                            });
                            tdAct.appendChild(delBtn);

                            tr.append(tdS, tdP, tdA1, tdType, tdVal, tdAct);
                            apprBody.appendChild(tr);
                        });
                    }
                } // render

                function tryParseRange(a1) {
                    const m = String(a1 || "").trim().toUpperCase().match(/^([A-Z]+)(\d+):([A-Z]+)(\d+)$/);
                    if (!m || m[1] !== m[3]) return null;
                    let r1 = parseInt(m[2], 10), r2 = parseInt(m[4], 10);
                    if (r2 < r1) [r1, r2] = [r2, r1];
                    return { col: m[1], r1, r2 };
                }

                function expandFieldsForSave(fields) {
                    const out = [];
                    for (const f of fields) {
                        const a1 = f?.Cell?.A1 || "";
                        const rg = tryParseRange(a1);
                        if (!rg) { out.push(f); continue; }

                        const tpl = (f.Key || "").trim();
                        let idx = 1;
                        for (let r = rg.r1; r <= rg.r2; r++, idx++) {
                            let keyBase = (tpl || "Field");
                            let key = keyBase;
                            if (key.includes("{n}")) key = key.replaceAll("{n}", String(idx));
                            if (key.includes("{row}")) key = key.replaceAll("{row}", String(r));
                            if (key === keyBase) key = `${keyBase}_${r}`;
                            out.push({ Key: key, Type: f.Type || "Text", Cell: { A1: `${rg.col}${r}` } });
                        }
                    }
                    return out;
                }

                function hasDuplicateKeys(items) {
                    const seen = new Set();
                    for (const it of items) {
                        const k = (it.Key || "").trim();
                        if (!k) return { ok: false, reason: "empty" };
                        if (seen.has(k)) return { ok: false, reason: "dup", key: k };
                        seen.add(k);
                    }
                    return { ok: true };
                }

                function validateApprovals(apprs) {
                    for (let i = 0; i < apprs.length; i++) {
                        const a = apprs[i] || {};
                        const slot = parseInt(a.Slot ?? 1, 10);
                        if (!Number.isFinite(slot) || slot < 1) {
                            return { ok: false, msg: `결재란 #${i + 1}: Slot은 1 이상 정수여야 합니다.` };
                        }
                        const t = (a.ApproverType || "Person");
                        if (!["Person", "Role", "Rule"].includes(t)) {
                            return { ok: false, msg: "결재권자 유형이 올바르지 않습니다." };
                        }
                        const v = (a.ApproverValue || "").trim();
                        if (t === "Person" || t === "Role") {
                            if (!v) {
                                return {
                                    ok: false,
                                    msg: `결재란 #${i + 1}: ${t === "Person" ? "사용자 ID" : "역할 코드"}를 입력해 주세요.`
                                };
                            }
                        } else if (t === "Rule") {
                            if (!v) return { ok: false, msg: `결재란 #${i + 1}: 규칙 JSON을 입력해 주세요.` };
                            try {
                                const obj = JSON.parse(v);
                                if (obj == null || typeof obj !== "object") throw 0;
                            } catch {
                                return { ok: false, msg: `결재란 #${i + 1}: 규칙 JSON 구문이 올바르지 않습니다.` };
                            }
                        }
                    }
                    return { ok: true };
                }

                document.getElementById("btnAddField").addEventListener("click", () => {
                    desc.Fields.push({ Key: "", Type: "Text", Cell: { A1: "" } });
                    render();
                });
                document.getElementById("btnAddAppr").addEventListener("click", () => {
                    desc.Approvals.push({ Slot: 1, Part: "", Cell: { A1: "" }, ApproverType: "Person", ApproverValue: "" });
                    render();
                });

                document.getElementById("btnSave").addEventListener("click", () => {
                    const payload = JSON.parse(JSON.stringify(desc));
                    payload.Fields = expandFieldsForSave(desc.Fields);

                    const ck = hasDuplicateKeys(payload.Fields);
                    if (!ck.ok) {
                        if (ck.reason === "empty") alert(L.MsgKeyEmpty);
                        else if (ck.reason === "dup") alert(L.MsgKeyDup + " " + (ck.key || ""));
                        return;
                    }
                    const v2 = validateApprovals(payload.Approvals || []);
                    if (!v2.ok) { alert(v2.msg); return; }

                    document.getElementById("descriptor").value = JSON.stringify(payload);

                    const prevRaw = (document.getElementById("PreviewJson")?.textContent || "").trim();
                    document.getElementById("previewJson").value = prevRaw || "";

                    document.getElementById("mapForm").submit();
                });

                render();
            })();
        });
    </script>
}
else
{
    @section Scripts {
    <script>
        (function (run) {
            if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", run);
            else run();
        })(function () {
            const L = {
                PickCell: @Html.Raw(JsonSerializer.Serialize(S["DTL_Btn_PickCell"].Value)),
                NoRows: @Html.Raw(JsonSerializer.Serialize(S["DTL_Msg_NoRows"].Value)),
                NoPreview: @Html.Raw(JsonSerializer.Serialize(S["DTL_NoPreview"].Value)),
                Delete: @Html.Raw(JsonSerializer.Serialize(S["_CM_Delete"].Value)),
                MsgKeyEmpty: @Html.Raw(JsonSerializer.Serialize(S["DTL_Msg_FieldKeyEmpty"].Value)),
                MsgKeyDup: @Html.Raw(JsonSerializer.Serialize(S["DTL_Msg_FieldKeyDup"].Value)),
                UserSearchPH: @Html.Raw(JsonSerializer.Serialize(S["DTL_User_SearchPH"].Value)),
                UserNoResult: @Html.Raw(JsonSerializer.Serialize(S["DTL_User_NoResult"].Value)),
                UserLoading: @Html.Raw(JsonSerializer.Serialize(S["DTL_User_Loading"].Value)),
                UserClear: @Html.Raw(JsonSerializer.Serialize(S["DTL_User_Clear"].Value))
            };
            const T = {
                TypeText: @Html.Raw(JsonSerializer.Serialize(S["DTL_Type_Text"].Value)),
                TypeDate: @Html.Raw(JsonSerializer.Serialize(S["DTL_Type_Date"].Value)),
                TypeNum: @Html.Raw(JsonSerializer.Serialize(S["DTL_Type_Num"].Value))
            };
            const USER_API = @Html.Raw(JsonSerializer.Serialize(Url.Action("SearchUser", "DocTL")));

            function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }
            async function fetchUsers(q, take = 20) {
                const url = new URL(USER_API, location.origin);
                if (q && q.trim()) url.searchParams.set("q", q.trim());
                url.searchParams.set("take", take);
                const r = await fetch(url.toString(), { headers: { "X-Requested-With": "XMLHttpRequest" } });
                if (!r.ok) return [];
                return await r.json();
            }
            async function fetchUserById(id) {
                if (!id) return null;
                const url = new URL(USER_API, location.origin);
                url.searchParams.set("id", id);
                const r = await fetch(url.toString(), { headers: { "X-Requested-With": "XMLHttpRequest" } });
                if (!r.ok) return null;
                const arr = await r.json();
                return Array.isArray(arr) && arr.length ? arr[0] : null;
            }

            (function () {
                const raw = (document.getElementById("DescriptorJson")?.textContent || "{}").trim();
                let desc = {}; try { desc = JSON.parse(raw); } catch { desc = {}; }
                if (!Array.isArray(desc.Fields)) desc.Fields = [];
                if (!Array.isArray(desc.Approvals)) desc.Approvals = [];

                const fieldsBody = document.getElementById("tblFieldsBody");
                const apprBody = document.getElementById("tblApprBody");

                function opt(val, text, sel) { const o = document.createElement("option"); o.value = val; o.text = text; if (sel) o.selected = true; return o; }
                window.__a1 = window.__a1 || {};

                async function buildUserSelect(selectedId) {
                    const sel = document.createElement("select");
                    sel.className = "form-select form-select-sm";
                    sel.append(opt("", "—", false));
                    let list = [];
                    try { list = await fetchUsers("", 50); } catch { list = []; }
                    list.forEach(x => sel.append(opt(x.id, x.text, x.id == selectedId)));
                    return sel;
                }

                function render() {
                    fieldsBody.innerHTML = "";
                    if (desc.Fields.length === 0) {
                        const tr = document.createElement("tr"); const td = document.createElement("td");
                        td.colSpan = 4; td.className = "text-muted"; td.textContent = L.NoRows; tr.appendChild(td); fieldsBody.appendChild(tr);
                    } else {
                        desc.Fields.forEach((f, i) => {
                            const tr = document.createElement("tr");

                            const tdKey = document.createElement("td");
                            const inpKey = document.createElement("input");
                            inpKey.className = "form-control form-control-sm key-input";
                            inpKey.placeholder = "예: Item_{n} 또는 Item_{row}";
                            inpKey.value = f.Key || "";
                            inpKey.addEventListener("input", e => { desc.Fields[i].Key = e.target.value; });
                            tdKey.appendChild(inpKey);

                            const tdType = document.createElement("td");
                            const sel = document.createElement("select");
                            sel.className = "form-select form-select-sm";
                            sel.append(opt("Text", T.TypeText, (f.Type || "Text") === "Text"));
                            sel.append(opt("Date", T.TypeDate, (f.Type || "Text") === "Date"));
                            sel.append(opt("Num", T.TypeNum, (f.Type || "Text") === "Num"));
                            sel.addEventListener("change", e => { desc.Fields[i].Type = e.target.value; });
                            tdType.appendChild(sel);

                            const tdA1 = document.createElement("td"); tdA1.className = "cell-a1";
                            const grp = document.createElement("div"); grp.className = "input-group input-group-sm";

                            const inputA1 = document.createElement("input");
                            inputA1.className = "form-control"; inputA1.placeholder = "예: C9 또는 C9:C35";
                            inputA1.value = (f.Cell && f.Cell.A1) || "";
                            inputA1.addEventListener("input", e => { desc.Fields[i].Cell = desc.Fields[i].Cell || {}; desc.Fields[i].Cell.A1 = e.target.value; });
                            inputA1.addEventListener("focus", () => {
                                window.__a1.set = (a1) => {
                                    desc.Fields[i].Cell = desc.Fields[i].Cell || {};
                                    desc.Fields[i].Cell.A1 = a1;
                                    inputA1.value = a1;
                                    inputA1.classList.add("a1-active");
                                    setTimeout(() => inputA1.classList.remove("a1-active"), 800);
                                };
                            });

                            const pickBtn = document.createElement("button");
                            pickBtn.type = "button"; pickBtn.className = "btn btn-outline-secondary d-none";
                            pickBtn.textContent = L.PickCell;
                            pickBtn.addEventListener("click", () => {
                                inputA1.focus();
                                document.getElementById("xlPreview").scrollIntoView({ behavior: "smooth", block: "start" });
                            });

                            grp.append(inputA1, pickBtn);
                            tdA1.appendChild(grp);

                            const tdAct = document.createElement("td");
                            const delBtn = document.createElement("button");
                            delBtn.type = "button";
                            delBtn.className = "btn btn-outline-danger btn-sm"; delBtn.textContent = L.Delete;
                            delBtn.addEventListener("click", () => { desc.Fields.splice(i, 1); render(); });
                            tdAct.appendChild(delBtn);

                            tr.append(tdKey, tdType, tdA1, tdAct);
                            fieldsBody.appendChild(tr);
                        });
                    }

                    apprBody.innerHTML = "";
                    if (desc.Approvals.length === 0) {
                        const tr = document.createElement("tr"); const td = document.createElement("td");
                        td.colSpan = 6; td.className = "text-muted"; td.textContent = L.NoRows; tr.appendChild(td); apprBody.appendChild(tr);
                    } else {
                        desc.Approvals.forEach((a, i) => {
                            a = a || {}; if (!a.Cell) a.Cell = {}; if (!a.ApproverType) a.ApproverType = "Person"; if (a.ApproverValue == null) a.ApproverValue = "";

                            const tr = document.createElement("tr");

                            const tdS = document.createElement("td");
                            const inpS = document.createElement("input");
                            inpS.type = "number"; inpS.min = "1"; inpS.className = "form-control form-control-sm";
                            inpS.value = a.Slot ?? 1; inpS.addEventListener("input", e => { desc.Approvals[i].Slot = parseInt(e.target.value || "1", 10); });
                            tdS.appendChild(inpS);

                            const tdP = document.createElement("td");
                            const inpP = document.createElement("input");
                            inpP.className = "form-control form-control-sm";
                            inpP.value = a.Part || ""; inpP.addEventListener("input", e => { desc.Approvals[i].Part = e.target.value; });
                            tdP.appendChild(inpP);

                            const tdA1 = document.createElement("td"); tdA1.className = "cell-a1";
                            const grpA1 = document.createElement("div"); grpA1.className = "input-group input-group-sm";
                            const inputA1 = document.createElement("input");
                            inputA1.className = "form-control"; inputA1.placeholder = "예: H4";
                            inputA1.value = a.Cell.A1 || "";
                            inputA1.addEventListener("input", e => {
                                desc.Approvals[i].Cell = desc.Approvals[i].Cell || {};
                                desc.Approvals[i].Cell.A1 = e.target.value;
                            });
                            inputA1.addEventListener("focus", () => {
                                window.__a1.set = (a1) => {
                                    desc.Approvals[i].Cell = desc.Approvals[i].Cell || {};
                                    desc.Approvals[i].Cell.A1 = a1;
                                    inputA1.value = a1;
                                    inputA1.classList.add("a1-active");
                                    setTimeout(() => inputA1.classList.remove("a1-active"), 800);
                                };
                            });
                            grpA1.append(inputA1);
                            tdA1.appendChild(grpA1);

                            const tdType = document.createElement("td");
                            const selType = document.createElement("select");
                            selType.className = "form-select form-select-sm";
                            [["Person", "개인(사용자)"], ["Role", "역할 코드"], ["Rule", "규칙(조건)"]].forEach(([v, l]) => {
                                const o = document.createElement("option");
                                o.value = v;
                                o.text = l;
                                if ((a.ApproverType || "Person") === v) o.selected = true;
                                selType.appendChild(o);
                            });
                            selType.addEventListener("change", e => {
                                const t = e.target.value;
                                desc.Approvals[i].ApproverType = t;
                                render();
                            });
                            tdType.appendChild(selType);

                            const tdVal = document.createElement("td");
                            if ((a.ApproverType || "Person") === "Person") {
                                const holder = document.createElement("div");
                                tdVal.appendChild(holder);
                                (async () => {
                                    const sel = await buildUserSelect(a.ApproverValue || "");
                                    sel.addEventListener("change", ev => {
                                        desc.Approvals[i].ApproverValue = ev.target.value || "";
                                    });
                                    holder.replaceChildren(sel);
                                })();
                            } else {
                                const inpVal = document.createElement("input");
                                inpVal.className = "form-control form-control-sm";
                                if ((a.ApproverType || "Person") === "Role") inpVal.placeholder = "역할 코드";
                                else inpVal.placeholder = "규칙 JSON";
                                inpVal.value = a.ApproverValue || "";
                                inpVal.addEventListener("input", e => {
                                    desc.Approvals[i].ApproverValue = e.target.value;
                                });
                                tdVal.appendChild(inpVal);
                            }

                            const tdAct = document.createElement("td");
                            const delBtn = document.createElement("button");
                            delBtn.type = "button";
                            delBtn.className = "btn btn-outline-danger btn-sm";
                            delBtn.textContent = L.Delete;
                            delBtn.addEventListener("click", () => {
                                desc.Approvals.splice(i, 1);
                                render();
                            });
                            tdAct.appendChild(delBtn);

                            tr.append(tdS, tdP, tdA1, tdType, tdVal, tdAct);
                            apprBody.appendChild(tr);
                        });
                    }
                } // render

                function tryParseRange(a1) {
                    const m = String(a1 || "").trim().toUpperCase().match(/^([A-Z]+)(\d+):([A-Z]+)(\d+)$/);
                    if (!m || m[1] !== m[3]) return null;
                    let r1 = parseInt(m[2], 10), r2 = parseInt(m[4], 10);
                    if (r2 < r1) [r1, r2] = [r2, r1];
                    return { col: m[1], r1, r2 };
                }

                function expandFieldsForSave(fields) {
                    const out = [];
                    for (const f of fields) {
                        const a1 = f?.Cell?.A1 || "";
                        const rg = tryParseRange(a1);
                        if (!rg) { out.push(f); continue; }

                        const tpl = (f.Key || "").trim();
                        let idx = 1;
                        for (let r = rg.r1; r <= rg.r2; r++, idx++) {
                            let keyBase = (tpl || "Field");
                            let key = keyBase;
                            if (key.includes("{n}")) key = key.replaceAll("{n}", String(idx));
                            if (key.includes("{row}")) key = key.replaceAll("{row}", String(r));
                            if (key === keyBase) key = `${keyBase}_${r}`;
                            out.push({ Key: key, Type: f.Type || "Text", Cell: { A1: `${rg.col}${r}` } });
                        }
                    }
                    return out;
                }

                function hasDuplicateKeys(items) {
                    const seen = new Set();
                    for (const it of items) {
                        const k = (it.Key || "").trim();
                        if (!k) return { ok: false, reason: "empty" };
                        if (seen.has(k)) return { ok: false, reason: "dup", key: k };
                        seen.add(k);
                    }
                    return { ok: true };
                }

                function validateApprovals(apprs) {
                    for (let i = 0; i < apprs.length; i++) {
                        const a = apprs[i] || {};
                        const slot = parseInt(a.Slot ?? 1, 10);
                        if (!Number.isFinite(slot) || slot < 1) {
                            return { ok: false, msg: `결재란 #${i + 1}: Slot은 1 이상 정수여야 합니다.` };
                        }
                        const t = (a.ApproverType || "Person");
                        if (!["Person", "Role", "Rule"].includes(t)) {
                            return { ok: false, msg: "결재권자 유형이 올바르지 않습니다." };
                        }
                        const v = (a.ApproverValue || "").trim();
                        if (t === "Person" || t === "Role") {
                            if (!v) {
                                return {
                                    ok: false,
                                    msg: `결재란 #${i + 1}: ${t === "Person" ? "사용자 ID" : "역할 코드"}를 입력해 주세요.`
                                };
                            }
                        } else if (t === "Rule") {
                            if (!v) return { ok: false, msg: `결재란 #${i + 1}: 규칙 JSON을 입력해 주세요.` };
                            try {
                                const obj = JSON.parse(v);
                                if (obj == null || typeof obj !== "object") throw 0;
                            } catch {
                                return { ok: false, msg: `결재란 #${i + 1}: 규칙 JSON 구문이 올바르지 않습니다.` };
                            }
                        }
                    }
                    return { ok: true };
                }

                document.getElementById("btnAddField").addEventListener("click", () => {
                    desc.Fields.push({ Key: "", Type: "Text", Cell: { A1: "" } });
                    render();
                });
                document.getElementById("btnAddAppr").addEventListener("click", () => {
                    desc.Approvals.push({ Slot: 1, Part: "", Cell: { A1: "" }, ApproverType: "Person", ApproverValue: "" });
                    render();
                });

                document.getElementById("btnSave").addEventListener("click", () => {
                    const payload = JSON.parse(JSON.stringify(desc));
                    payload.Fields = expandFieldsForSave(desc.Fields);

                    const ck = hasDuplicateKeys(payload.Fields);
                    if (!ck.ok) {
                        if (ck.reason === "empty") alert(L.MsgKeyEmpty);
                        else if (ck.reason === "dup") alert(L.MsgKeyDup + " " + (ck.key || ""));
                        return;
                    }
                    const v2 = validateApprovals(payload.Approvals || []);
                    if (!v2.ok) { alert(v2.msg); return; }

                    document.getElementById("descriptor").value = JSON.stringify(payload);

                    const prevRaw = (document.getElementById("PreviewJson")?.textContent || "").trim();
                    document.getElementById("previewJson").value = prevRaw || "";

                    document.getElementById("mapForm").submit();
                });

                render();
            })();
        });
    </script>
    }
}
