@* 2025.11.19 Changed: Detail 레이아웃을 Compose/Board 공통 scroll host 방식으로 통일
   - html/body 전역 스크롤 hidden + #doc-scroll fixed inset:0 한 곳만 세로 스크롤 담당
   - 가로 스크롤은 eb.doc.preview.common.js / eb.doc.preview.css 에서 관리하는 프리뷰 전용 컨테이너에 맡기고
     Detail 쪽에서는 #xlPreview/#xhost overflow 를 더 이상 덮어쓰지 않음(전역 가로 스크롤/문서 가림 현상 방지)
   - 헤더/사이드바/푸터는 레이아웃 고정 상태 유지, Detail 타이틀/문서가 헤더 밑에 가려지지 않도록 placeContainer() 사용 *@
@using System.Text.Json
@model WebApplication1.Models.DocTLViewModel
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> S

@{
    ViewData["Title"] = S["DOC_Title_Detail"];

    var docId =
        (string?)ViewBag.DocId
        ?? (string?)ViewBag.DocumentId
        ?? (Context?.Request?.Query["id"].ToString() ?? string.Empty);

    var templateCode = (string?)ViewBag.TemplateCode ?? string.Empty;
    var templateTitle = (string?)ViewBag.TemplateTitle ?? string.Empty;
    var status = (string?)ViewBag.Status ?? "Draft";

    string NormalizeJson(object value, string emptyJson = "{}")
    {
        if (value == null) return emptyJson;

        if (value is string s)
        {
            s = s.Trim();
            if (string.IsNullOrEmpty(s)) return emptyJson;

            if ((s.StartsWith("{") && s.EndsWith("}")) ||
                (s.StartsWith("[") && s.EndsWith("]")))
                return s;

            return s;
        }

        try { return JsonSerializer.Serialize(value); }
        catch { return emptyJson; }
    }

    string NormalizeJsonArray(object value) => NormalizeJson(value, "[]");

    var descJson = NormalizeJson(ViewBag.DescriptorJson);
    var previewJson = NormalizeJson(ViewBag.PreviewJson);
    var inputsJson = NormalizeJson(ViewBag.InputsJson);
    var approvalsJson = NormalizeJsonArray(ViewBag.ApprovalsJson);
    var viewLogsJson = NormalizeJsonArray(ViewBag.ViewLogsJson);

    var canBackToNew = (bool?)ViewBag.CanBackToNew ?? true;
    var canPrint = (bool?)ViewBag.CanPrint ?? true;
    var canExport = (bool?)ViewBag.CanExportPdf ?? true;

    bool canRecall = ViewBag.CanRecall is bool b1 && b1;
    bool canApprove = ViewBag.CanApprove is bool b2 && b2;
    bool canHold = ViewBag.CanHold is bool b3 && b3;
    bool canReject = ViewBag.CanReject is bool b4 && b4;
}

<style>
    /* ===== 전역 스크롤 차단: 작업 영역(#doc-scroll)만 스크롤 허용 ===== */
    html,
    body {
        height: 100%;
        overflow: hidden !important;
        background: #fff;
        margin: 0;
    }

    /* ===== Detail 작업 영역 컨테이너
           - Compose 와 동일하게 레이아웃 CSS 변수 기준 고정
           - placeContainer() 가 inline 으로 top/left/right/bottom 을 써도
             아래 !important 가 항상 우선 ===== */
    #doc-scroll {
        position: fixed;
        top: var(--header-h, 56px) !important;
        right: 0 !important;
        bottom: var(--footer-h, 32px) !important;
        left: var(--sidebar-w, 270px) !important;
        box-sizing: border-box;
        padding: 16px 24px;
        background: #fff;
        overflow-y: auto; /* 세로 스크롤만 사용 */
        overflow-x: hidden; /* 가로 스크롤은 프리뷰 내부 컨테이너에서 처리 */
        overscroll-behavior: contain;
    }

    .doc-detail-root {
        padding-top: .5rem;
        padding-bottom: 1.5rem;
    }

    .doc-detail-header {
        padding-top: .75rem;
        margin-bottom: 1rem;
    }

    .doc-detail-title {
        font-size: 1.35rem;
        font-weight: 600;
    }

    .doc-detail-meta {
        display: flex;
        flex-wrap: wrap;
        gap: .4rem .9rem;
        margin-top: .35rem;
        font-size: .85rem;
        color: #6b7280;
    }

    .doc-detail-actions {
        display: flex;
        flex-wrap: wrap;
        gap: .25rem;
        margin-top: .5rem;
    }

    .badge.status-Draft {
        background: #e2e8f0;
        color: #111827;
    }

    .badge.status-Submitted {
        background: #c7d2fe;
        color: #1e1b4b;
    }

    .badge.status-InProgress {
        background: #fde68a;
        color: #78350f;
    }

    .badge.status-Approved {
        background: #bbf7d0;
        color: #065f46;
    }

    .badge.status-Rejected {
        background: #fecaca;
        color: #7f1d1d;
    }

    .doc-section {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: .375rem;
        padding: .75rem .875rem;
        margin-bottom: .75rem;
    }

    .doc-section-title {
        font-size: .95rem;
        font-weight: 600;
        margin-bottom: .35rem;
        display: flex;
        align-items: center;
        gap: .4rem;
    }

    .doc-section-sub {
        font-size: .78rem;
        color: #9ca3af;
        margin-left: .15rem;
    }

    .doc-preview-full {
        padding: 0;
        margin: 0 0 1rem 0;
        border: none;
        background: transparent;
    }

    .doc-comments-list {
        max-height: 260px;
        overflow-y: auto;
        padding-right: 2px;
        display: flex;
        flex-direction: column;
        gap: .5rem;
        font-size: .86rem;
    }

    .doc-comment-item {
        border-bottom: 1px solid #f3f4f6;
        padding-bottom: .35rem;
    }

    .doc-comment-meta {
        display: flex;
        flex-wrap: wrap;
        gap: .5rem;
        font-size: .78rem;
        color: #9ca3af;
    }

    .doc-comment-body {
        margin-top: .15rem;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .doc-comment-files {
        margin-top: .15rem;
        font-size: .78rem;
    }

    .doc-comment-form textarea {
        width: 100%;
        resize: vertical;
        min-height: 80px;
    }

    #cmt-file-list li {
        display: flex;
        align-items: center;
        gap: .5rem;
    }

    #cmt-file-list button[data-remove] {
        padding: .1rem .4rem;
    }

    .doc-viewlog-list {
        max-height: 160px;
        overflow-y: auto;
        font-size: .8rem;
        white-space: nowrap;
    }

    .doc-approvals-table {
        width: 100%;
        font-size: .8rem;
    }

        .doc-approvals-table th,
        .doc-approvals-table td {
            padding: .25rem .4rem;
            border: 1px solid #e5e7eb;
        }

    .doc-approvals-actions {
        display: flex;
        flex-wrap: wrap;
        gap: .35rem;
        justify-content: flex-end;
        margin-top: .4rem;
    }

    /* ================== 인쇄 전용 ================== */
    @@media print {
        @@page {
            size: A4 portrait;
            margin: 0;
        }

        html,
        body {
            margin: 0 !important;
            padding: 0 !important;
            background: #fff !important;
            height: auto !important;
            min-height: 0 !important;
            overflow: visible !important;
        }

            body * {
                visibility: hidden !important;
            }

        #print-xhost-wrapper,
        #print-xhost-wrapper * {
            visibility: visible !important;
        }

        #print-xhost-wrapper {
            position: fixed !important;
            inset: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            max-width: none !important;
            background: #fff !important;
        }

            #print-xhost-wrapper #xhost {
                margin: 0 0 0 12px !important;
                padding: 0 !important;
                width: 100% !important;
                max-width: none !important;
                overflow: visible !important;
                background: #fff !important;
            }

                #print-xhost-wrapper #xhost .xlfb {
                    display: table !important;
                    table-layout: fixed !important;
                    border-collapse: collapse !important;
                    width: 100% !important;
                    margin: 0 !important;
                    padding: 0 !important;
                    outline: none !important;
                }

                    #print-xhost-wrapper #xhost .xlfb tr {
                        display: table-row !important;
                    }

                    #print-xhost-wrapper #xhost .xlfb td,
                    #print-xhost-wrapper #xhost .xlfb th {
                        display: table-cell !important;
                        vertical-align: middle !important;
                        page-break-inside: auto !important;
                        break-inside: auto !important;
                    }
        /* ★ Compose 와 동일: 인쇄 시에는 doc-scroll 고정 해제 */
        #doc-scroll {
            overflow: visible !important;
            position: static !important;
            top: auto !important;
            right: auto !important;
            bottom: auto !important;
            left: auto !important;
            height: auto !important;
            padding: 0 !important;
        }
    }
</style>

<div id="doc-scroll">
    <div class="container-xxl doc-detail-root" data-doc-id="@docId">
        <header class="doc-detail-header">
            <div class="doc-detail-title">@S["DOC_Title_Detail"]</div>

            <div class="doc-detail-actions">
                @if (canBackToNew)
                {
                    <a href="/Doc/New" class="btn btn-sm btn-outline-secondary">
                        @S["DOC_Btn_BackToNew"]
                    </a>
                }
                @if (canPrint)
                {
                    <button type="button"
                            class="btn btn-sm btn-outline-primary"
                            id="btnPrint"
                            title="@S["DOC_Btn_Print"]">
                        <i class="bi bi-printer"></i>
                    </button>
                }
                @if (canExport)
                {
                    <button type="button"
                            class="btn btn-sm btn-outline-primary"
                            id="btnExport"
                            title="@S["DOC_Btn_Export"]">
                        <i class="bi bi-file-earmark-pdf"></i>
                    </button>
                }
            </div>

            <div class="doc-detail-meta">
                <span><strong>@S["DOC_Label_DocId"]</strong> : <code>@docId</code></span>
                <span>
                    <strong>@S["_CM_Label_Template"]</strong> :
                    <code>@templateCode</code>
                    <span class="ms-1">@templateTitle</span>
                </span>
                <span class="badge status-@status">@S[$"DOC_Status_{status}"]</span>
            </div>
        </header>

        <div id="detail-alert" class="mb-2" aria-live="polite"></div>

        <section class="doc-preview-full" aria-label="Document preview">
            <script type="application/json" id="DescriptorJson">@Html.Raw(descJson)</script>
            <script type="application/json" id="PreviewJson">@Html.Raw(previewJson)</script>
            <script type="application/json" id="InputsJson">@Html.Raw(inputsJson)</script>
            <script type="application/json" id="ViewLogsJson">@Html.Raw(viewLogsJson)</script>
            <script type="application/json" id="ApprovalsJson">@Html.Raw(approvalsJson)</script>

            <div id="xlPreview">
                <div id="xhost"></div>
            </div>
        </section>

        <section class="doc-section" aria-labelledby="doc-comments-list-title">
            <div id="doc-comments-list-title" class="doc-section-title">
                @S["_CM_Comment_Label"]
                <span id="cmt-count" class="doc-section-sub"></span>
            </div>
            <div id="cmt-alert" class="mb-1" aria-live="polite"></div>
            <div id="cmt-list" class="doc-comments-list"></div>
        </section>

        <section class="doc-section" aria-labelledby="doc-comment-form-title">
            <div id="doc-comment-form-title" class="doc-section-title">
                @S["DOC_Label_AddComment"]
            </div>
            <div class="doc-comment-form">
                <textarea id="cmt-body"
                          class="form-control"
                          rows="3"
                          placeholder="@S["DOC_Placeholder_Comment"]"></textarea>

                <div class="mt-2">
                    <input id="cmt-file" type="file" class="form-control form-control-sm" multiple />
                    <div class="small text-muted mt-1">@S["DOC_File_Help_UploadTypes"]</div>
                    <ul id="cmt-file-list" class="mt-2 mb-0 small"></ul>
                </div>

                <div class="d-flex gap-2 mt-2 justify-content-end">
                    <button id="cmt-submit" type="button" class="btn btn-sm btn-primary">
                        @S["DOC_Btn_CommentPost"]
                    </button>
                </div>
            </div>
        </section>

        <section class="doc-section" aria-labelledby="doc-viewlog-title">
            <div id="doc-viewlog-title" class="doc-section-title">
                @S["DOC_Title_ViewLog"]
            </div>
            <div id="viewlog-list" class="doc-viewlog-list"></div>
        </section>

        <section class="doc-section" aria-labelledby="doc-approvals-title">
            <div id="doc-approvals-title" class="doc-section-title">
                @S["DOC_Label_Approvals"]
                <span class="doc-section-sub">@S["DOC_Help_ApprovalsReadonly"]</span>
            </div>

            <table class="doc-approvals-table">
                <thead>
                    <tr>
                        <th style="width:18%;">@S["DOC_Col_ApproverRole"]</th>
                        <th>@S["DOC_Col_ApproverValue"]</th>
                        <th style="width:12%;">@S["DOC_Col_Status"]</th>
                        <th style="width:18%;">@S["DOC_Col_ApprovalTime"]</th>
                    </tr>
                </thead>
                <tbody id="tbody-approvals"></tbody>
            </table>

            <div class="doc-approvals-actions">
                <button id="btnRecall"
                        type="button"
                        class="btn btn-secondary"
                        data-can="@(canRecall ? "True" : "False")">
                    @S["DOC_Btn_Recall"]
                </button>
                <button id="btnApprove"
                        type="button"
                        class="btn btn-success"
                        data-can="@(canApprove ? "True" : "False")">
                    @S["DOC_Btn_Approve"]
                </button>
                <button id="btnHold"
                        type="button"
                        class="btn btn-sm btn-warning"
                        data-can="@(canHold ? "True" : "False")">
                    @S["DOC_Btn_Hold"]
                </button>
                <button id="btnReject"
                        type="button"
                        class="btn btn-sm btn-danger"
                        data-can="@(canReject ? "True" : "False")">
                    @S["DOC_Btn_Reject"]
                </button>
            </div>
        </section>
    </div>

    <div id="print-xhost-wrapper"></div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/eb.doc.preview.css" asp-append-version="true" />
}

@section Scripts {
    <script src="~/js/eb.csrf.js"></script>

    <script>
        function decodeHtmlEntities(str) {
            if (str == null) return '';
            let s = String(str);
            s = s.replace(/&#x([0-9a-fA-F]+);/g, (_, h) => String.fromCodePoint(parseInt(h, 16)));
            s = s.replace(/&#(\d+);/g, (_, d) => String.fromCodePoint(parseInt(d, 10)));
            s = s.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&')
                .replace(/&quot;/g, '"').replace(/&apos;/g, "'");
            return s;
        }

        window.__RESX = {
            DOC_Err_PreviewFailed: "@S["DOC_Err_PreviewFailed"]",
            DOC_Msg_PreviewFallback: "@S["DOC_Msg_PreviewFallback"]",
            DOC_Msg_NoComments: "@S["DOC_Msg_NoComments"]",
            DOC_Msg_NoViewLogs: "@S["DOC_Msg_NoViewLogs"]",
            DOC_Msg_NoApprovals: "@S["DOC_Msg_NoApprovals"]",
            DOC_Msg_CommentCreated: "@S["DOC_Msg_CommentCreated"]",
            DOC_Msg_CommentDeleted: "@S["DOC_Msg_CommentDeleted"]",
            DOC_Err_SaveFailed: "@S["DOC_Err_SaveFailed"]",
            DOC_Err_DeleteFailed: "@S["DOC_Err_DeleteFailed"]",
            DOC_Err_LoadFailed: "@S["DOC_Err_LoadFailed"]",
            DOC_Err_DocumentNotFound: "@S["DOC_Err_DocumentNotFound"]",
            DOC_Msg_Approve_Success: "@S["DOC_Msg_Approve_Success"]",
            DOC_Val_Required: "@S["DOC_Val_Required"]",
            DOC_Cmt_Count: "@S["DOC_Cmt_Count"]",
            DOC_Btn_Reply: "@S["DOC_Btn_Reply"]",
            DOC_Btn_Delete: "@S["DOC_Btn_Delete"]",
            DOC_Placeholder_Reply: "@S["DOC_Placeholder_Reply"]",
            DOC_StatusShort_Pending: "@S["DOC_StatusShort_Pending"]"
        };

        const T = (m) => {
            if (m == null) return '';
            if (Array.isArray(m)) return m.map(T).join('\n');
            const s = String(m);
            const mapped = (window.__RESX && Object.prototype.hasOwnProperty.call(window.__RESX, s))
                ? window.__RESX[s] : s;
            return decodeHtmlEntities(mapped);
        };

        function readJsonFromScript(id, fallback) {
            try {
                const el = document.getElementById(id);
                if (!el) return fallback;
                const raw = el.textContent || '';
                if (!raw.trim()) return fallback;
                let v = JSON.parse(raw);
                if (typeof v === 'string') {
                    try { v = JSON.parse(v); } catch { }
                }
                return (v && typeof v === 'object') ? v : fallback;
            } catch { return fallback; }
        }

        const docId = "@(docId ?? "")";
    </script>

    <script>
        window.__DOC_IS_WRITE__ = false;
    </script>

    <script src="~/js/eb.doc.preview.common.js"></script>
    <script src="~/js/html2pdf.bundle.min.js"></script>

    <script>
        (function initComments() {
            const EBV = window.EBValidate || {};
            const rawFetch = (window.fetch || function () { }).bind(window);

            const EBC = (window.EBCSRF || window.EBCsrf) || {
                async fetch(url, options) {
                    const res = await rawFetch(url, options || {});
                    return res;
                },
                async json(url, payload, method = 'POST') {
                    const res = await rawFetch(url, {
                        method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: method === 'GET' ? undefined : JSON.stringify(payload || {})
                    });
                    const j = await res.json().catch(() => ({}));
                    if (!res.ok) {
                        const err = new Error('request failed');
                        err.payload = j;
                        throw err;
                    }
                    return j;
                }
            };

            const $list = document.getElementById('cmt-list');
            const $alert = document.getElementById('cmt-alert');
            const $count = document.getElementById('cmt-count');
            const $fileIn = document.getElementById('cmt-file');
            const $fileList = document.getElementById('cmt-file-list');
            const $body = document.getElementById('cmt-body');
            const $submit = document.getElementById('cmt-submit');

            const docIdAttr = document.querySelector('.doc-detail-root')?.getAttribute('data-doc-id') || '';

            if (!docIdAttr) {
                showErr([T('DOC_Err_DocumentNotFound')]);
                return;
            }

            let pendingFiles = [];

            $fileIn?.addEventListener('change', () => {
                pendingFiles = Array.from($fileIn.files || []);
                renderFileList();
            });

            $fileList.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-remove]');
                if (!btn) return;
                const idx = Number(btn.getAttribute('data-remove'));
                if (!Number.isNaN(idx)) {
                    pendingFiles.splice(idx, 1);
                    $fileIn.value = '';
                    renderFileList();
                }
            });

            function renderFileList() {
                $fileList.innerHTML = '';
                pendingFiles.forEach((f, i) => {
                    const li = document.createElement('li');
                    li.innerHTML =
                        `<span>${escapeHtml(f.name)}</span>
                                 <span class="text-muted">(${Number(f.size || 0).toLocaleString()})</span>
                                 <button type="button" class="btn btn-outline-secondary btn-sm" data-remove="${i}">&times;</button>`;
                    $fileList.append(li);
                });
            }

            async function loadComments() {
                try {
                    const res = await EBC.fetch('/Doc/Comments?docId=' + encodeURIComponent(docIdAttr), {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    const data = await res.json().catch(() => ({}));
                    const items = Array.isArray(data.items) ? data.items : [];
                    renderComments(items);
                } catch (e) {
                    console.error('loadComments error', e);
                    showErr([T('DOC_Err_LoadFailed')]);
                }
            }

            function renderComments(items) {
                $list.innerHTML = '';
                if (!items.length) {
                    $count.textContent = '';
                    $list.innerHTML = `<div class="text-muted">${T('DOC_Msg_NoComments')}</div>`;
                    return;
                }

                $count.textContent = T('DOC_Cmt_Count').replace('{n}', items.length);

                items.forEach(c => {
                    const wrap = document.createElement('div');
                    wrap.className = 'doc-comment-item';

                    const depth = Math.min(c.depth || 0, 4);
                    if (depth > 0) wrap.style.marginLeft = (depth * 16) + 'px';

                    wrap.innerHTML = `
                                <div class="doc-comment-meta">
                                    <span><strong>${escapeHtml(c.createdBy || '')}</strong></span>
                                    <span>${escapeHtml(c.createdAt || '')}</span>
                                </div>
                                <div class="doc-comment-body">${nl2br(escapeHtml(c.body || ''))}</div>
                            `;

                    $list.append(wrap);
                });
            }

            $submit?.addEventListener('click', async () => {
                const body = ($body.value || '').trim();
                if (!body) {
                    showErr([T('DOC_Val_Required')]);
                    return;
                }

                try {
                    const payload = {
                        docId: docIdAttr,
                        parentCommentId: null,
                        body: body,
                        files: []
                    };

                    await EBC.json('/Doc/Comments', payload, 'POST');

                    $body.value = '';
                    pendingFiles = [];
                    if ($fileIn) $fileIn.value = '';
                    renderFileList();

                    $alert.innerHTML = '';
                    await loadComments();
                } catch (e) {
                    console.error('post comment error', e);
                    const p = e && e.payload;
                    showErr(p?.messages || [T('DOC_Err_SaveFailed')]);
                }
            });

            function showErr(msgs) {
                if (EBV.showAlert) {
                    EBV.showAlert('cmt-alert', msgs, { variant: 'danger' });
                } else {
                    $alert.innerHTML =
                        `<div class="alert alert-danger py-1 mb-1">${(msgs || []).map(escapeHtml).join('<br>')}</div>`;
                }
            }

            function escapeHtml(s) {
                return String(s || '').replace(/[&<>"']/g,
                    m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
            }

            function nl2br(s) {
                return String(s || '').replace(/\n/g, '<br>');
            }

            loadComments();
        })();

        (function renderViewLogs() {
            const host = document.getElementById('viewlog-list');
            if (!host) return;

            // ViewLogsJson 안에 배열 또는 { items: [...] } 둘 다 지원
            const raw = readJsonFromScript('ViewLogsJson', []);
            let logs = [];

            if (Array.isArray(raw)) {
                logs = raw;
            } else if (raw && Array.isArray(raw.items)) {
                logs = raw.items;
            }

            // ★ 여기 두 줄을 console.log 로 변경
            console.log('[DOC DEBUG] viewlogs raw', raw);
            console.log('[DOC DEBUG] viewlogs parsed logs', logs);

            if (!logs.length) {
                host.innerHTML = `<div class="text-muted">${T('DOC_Msg_NoViewLogs')}</div>`;
                return;
            }

            host.innerHTML = '';
            logs
                .slice()
                .sort((a, b) =>
                    (b.viewedAt || b.ViewedAt || '').localeCompare(a.viewedAt || a.ViewedAt || '')
                )
                .forEach(v => {
                    const when =
                        v.viewedAtText || v.ViewedAtText ||
                        v.viewedAt || v.ViewedAt || '';
                    const who =
                        v.userName || v.UserName ||
                        v.userId || v.UserId || '';

                    const row = document.createElement('div');
                    row.textContent = `${when} - ${who}`;
                    host.append(row);
                });
        })();

        (function renderApprovals() {
            const tbody = document.getElementById('tbody-approvals');
            if (!tbody) return;

            const list = readJsonFromScript('ApprovalsJson', []);

            if (!Array.isArray(list) || !list.length) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="4" class="text-muted">${T('DOC_Msg_NoApprovals')}</td>`;
                tbody.append(tr);
                return;
            }

            const esc = s => String(s || '').replace(/[&<>"']/g,
                m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));

            list
                .slice()
                .sort((a, b) => (a.step || a.stepOrder || 0) - (b.step || b.stepOrder || 0))
                .forEach(a => {
                    const tr = document.createElement('tr');
                    const role = a.roleKey || a.Part || '';
                    const val = a.approverValue || a.value || a.approverName || '';
                    const st = a.status || a.Action || 'Pending';
                    const when = a.actedAtText || a.actedAt || '';
                    tr.innerHTML = `
                                <td>${esc(role)}</td>
                                <td>${esc(val)}</td>
                                <td>${esc(st)}</td>
                                <td>${esc(when)}</td>`;
                    tbody.append(tr);
                });
        })();

        document.getElementById('btnPrint')?.addEventListener('click', () => { window.print(); });
        document.getElementById('btnExport')?.addEventListener('click', () => {
            const host = document.getElementById('xhost');
            if (!host) {
                alert('미리보기 영역(#xhost)을 찾을 수 없습니다.');
                return;
            }

            if (typeof window.html2pdf === 'undefined') {
                console.error('html2pdf 모듈이 로드되지 않았습니다.');
                alert('PDF 모듈이 로드되지 않아 내보내기를 할 수 없습니다.\nhtml2pdf.bundle.min.js 경로를 확인해 주세요.');
                return;
            }

            // ★ 현재 렌더링된 서식의 실제 픽셀 크기 측정 (브라우저에 보이는 그대로)
            const rect = host.getBoundingClientRect();
            const w = Math.max(rect.width, 1);   // px
            const h = Math.max(rect.height, 1);  // px

            // ★ A4 고정 대신, 화면 렌더링된 크기 그대로 PDF 한 페이지로 만들기
            const opt = {
                margin: 0,
                filename: (docId ? docId : 'document') + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    scrollY: 0
                },
                jsPDF: {
                    unit: 'px',          // px 단위 그대로 사용
                    format: [w, h],      // 한 페이지 크기를 서식 크기와 동일하게
                    orientation: 'portrait'
                },
                pagebreak: { mode: ['css', 'legacy'] } // 혹시 모를 자동 분할 최소화
            };

            // #xhost 에 렌더링된 모양 그대로 한 장짜리 PDF 생성
            window.html2pdf()
                .set(opt)
                .from(host)
                .save();
        });

        (function () {
            const xhost = document.getElementById('xhost');
            if (!xhost) return;

            const originalParent = xhost.parentNode;
            const originalNext = xhost.nextSibling;

            let printWrapper = document.getElementById('print-xhost-wrapper');
            if (!printWrapper) {
                printWrapper = document.createElement('div');
                printWrapper.id = 'print-xhost-wrapper';
            }

            function moveToPrintWrapper() {
                if (printWrapper.parentNode !== document.body) {
                    document.body.appendChild(printWrapper);
                }
                if (xhost.parentNode !== printWrapper) {
                    printWrapper.appendChild(xhost);
                }
            }

            function restoreFromPrintWrapper() {
                if (!originalParent) return;

                xhost.style.transform = '';
                xhost.style.transformOrigin = '';

                if (originalNext && originalNext.parentNode === originalParent) {
                    originalParent.insertBefore(xhost, originalNext);
                } else {
                    originalParent.appendChild(xhost);
                }
            }

            function applyPrintScale() {
                try {
                    xhost.style.transform = '';
                    xhost.style.transformOrigin = 'top center';

                    const rect = xhost.getBoundingClientRect();
                    const pageW = window.innerWidth || rect.width || 1;
                    const pageH = window.innerHeight || rect.height || 1;

                    if (!rect.width || !rect.height) return;

                    const sx = pageW / rect.width;
                    const sy = pageH / rect.height;
                    const s = Math.min(sx, sy, 1);

                    xhost.style.transform = 'scale(' + s + ')';
                } catch (e) {
                    console.warn('applyPrintScale error', e);
                }
            }

            function handleBeforePrint() {
                moveToPrintWrapper();
                applyPrintScale();
            }

            function handleAfterPrint() {
                restoreFromPrintWrapper();
            }

            if (window.matchMedia) {
                const mq = window.matchMedia('print');
                mq.addEventListener('change', function (e) {
                    if (e.matches) handleBeforePrint();
                    else handleAfterPrint();
                });
            }

            window.addEventListener('beforeprint', handleBeforePrint);
            window.addEventListener('afterprint', handleAfterPrint);
        })();

        /* ===== Detail 프리뷰 초기화 ===== */
        (function () {
            function initPreview() {
                const api = window.EBDocPreview || {};

                if (typeof api.setWriteMode === 'function') {
                    api.setWriteMode(false);
                }

                if (typeof api.mount === 'function') {
                    try {
                        const raw = document.getElementById('PreviewJson')?.textContent || '{}';
                        const preview = JSON.parse(raw || '{}');
                        api.mount('#xlPreview', preview, { isWrite: false });
                    } catch (e) {
                        console.error('Detail preview init failed', e);
                        const host = document.getElementById('xhost');
                        if (host) {
                            const msg = (window.__RESX && window.__RESX.DOC_Err_PreviewFailed) || 'Preview error';
                            host.innerHTML =
                                '<div class="alert alert-danger mb-0 py-1">' + msg + '</div>';
                        }
                    }
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initPreview, { once: true });
            } else {
                initPreview();
            }
        })();

        (function () {
            const docId = '@docId';
            const url = '@Url.Action("ApproveOrHold", "Doc")';

            function send(action) {
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ docId, action })
                })
                    .then(r => {
                        if (!r.ok) throw new Error();
                        return r.json();
                    })
                    .then(() => location.reload())
                    .catch(() => alert('처리 중 오류가 발생했습니다.'));
            }

            function bind(btnId, action) {
                const btn = document.getElementById(btnId);
                if (!btn) return;
                const can = btn.dataset.can === 'True' || btn.dataset.can === 'true';
                btn.disabled = !can;
                if (!can) return;
                btn.addEventListener('click', () => send(action));
            }

            bind('btnRecall', 'Recall');
            bind('btnApprove', 'Approve');
            bind('btnHold', 'Hold');
            bind('btnReject', 'Reject');
        })();

        (function () {
            const docId = '@docId';
            const url = '@Url.Action("ApproveOrHold", "Doc")';

            function send(action) {
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ docId, action })
                })
                    .then(r => {
                        if (!r.ok) throw new Error();
                        return r.json();
                    })
                    .then(() => location.reload())
                    .catch(() => alert('처리 중 오류가 발생했습니다.'));
            }

            function bind(btnId, action) {
                const btn = document.getElementById(btnId);
                if (!btn) return;
                const can = btn.dataset.can === 'True' || btn.dataset.can === 'true';
                btn.disabled = !can;
                if (!can) return;
                btn.addEventListener('click', () => send(action));
            }

            bind('btnRecall', 'Recall');
            bind('btnApprove', 'Approve');
            bind('btnHold', 'Hold');
            bind('btnReject', 'Reject');
        })();
    </script>
}
