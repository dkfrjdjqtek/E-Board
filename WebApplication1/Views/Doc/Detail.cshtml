@* 2025.11.14 Changed: Compose와 동일한 #doc-scroll / #xlPreview 구조 적용, 엑셀 폰트 무시하고 웹 공통 프리뷰 폰트만 사용 *@
@using System.Text.Json
@model WebApplication1.Models.DocTLViewModel
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> S

@{
    ViewData["Title"] = S["DOC_Title_Detail"];

    // ★ docId를 실제 DocumentComments.DocId 와 동일하게 맞춰서 가져오도록 정리
    var docId =
        (string?)ViewBag.DocId
        ?? (string?)ViewBag.DocumentId
        ?? (Context?.Request?.Query["id"].ToString() ?? string.Empty);

    var templateCode = (string?)ViewBag.TemplateCode ?? string.Empty;
    var templateTitle = (string?)ViewBag.TemplateTitle ?? string.Empty;
    var status = (string?)ViewBag.Status ?? "Draft";

    string NormalizeJson(object value, string emptyJson = "{}")
    {
        if (value == null) return emptyJson;

        if (value is string s)
        {
            s = s.Trim();
            if (string.IsNullOrEmpty(s)) return emptyJson;

            if ((s.StartsWith("{") && s.EndsWith("}")) ||
                (s.StartsWith("[") && s.EndsWith("]")))
                return s;

            return s;
        }

        try { return JsonSerializer.Serialize(value); }
        catch { return emptyJson; }
    }

    string NormalizeJsonArray(object value) => NormalizeJson(value, "[]");

    var descJson = NormalizeJson(ViewBag.DescriptorJson);
    var previewJson = NormalizeJson(ViewBag.PreviewJson);
    var inputsJson = NormalizeJson(ViewBag.InputsJson);
    var approvalsJson = NormalizeJsonArray(ViewBag.ApprovalsJson);
    var viewLogsJson = NormalizeJsonArray(ViewBag.ViewLogsJson);

    var canBackToNew = (bool?)ViewBag.CanBackToNew ?? true;
    var canPrint = (bool?)ViewBag.CanPrint ?? true;
    var canExport = (bool?)ViewBag.CanExportPdf ?? true;
    var canApprove = (bool?)ViewBag.CanApprove ?? false;
    var canHold = (bool?)ViewBag.CanHold ?? false;
    var canReject = (bool?)ViewBag.CanReject ?? false;
}

<style>
    /* ================== Compose와 동일한 스크롤 컨테이너 ================== */
    html, body {
        height: 100%;
        overflow: hidden !important;
        background: #fff;
        margin: 0;
    }

    #doc-scroll {
        position: fixed;
        inset: 0;
        overflow-y: auto !important;
        overflow-x: auto !important;
        box-sizing: border-box;
        background: #fff;
        z-index: 1;
        scrollbar-gutter: stable both-edges;
        padding-bottom: 0;
    }

    .doc-detail-root {
        padding-top: 1.25rem;
        padding-bottom: 2rem;
    }

    .doc-detail-header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: .5rem 1rem;
        margin-bottom: 1rem;
    }

    .doc-detail-title {
        font-size: 1.35rem;
        font-weight: 600;
    }

    .doc-detail-meta {
        display: flex;
        flex-wrap: wrap;
        gap: .4rem .9rem;
        font-size: .85rem;
        color: #6b7280;
    }

    .doc-detail-actions {
        margin-left: auto;
        display: flex;
        flex-wrap: wrap;
        gap: .25rem;
    }

    .badge.status-Draft {
        background: #e2e8f0;
        color: #111827;
    }

    .badge.status-Submitted {
        background: #c7d2fe;
        color: #1e1b4b;
    }

    .badge.status-InProgress {
        background: #fde68a;
        color: #78350f;
    }

    .badge.status-Approved {
        background: #bbf7d0;
        color: #065f46;
    }

    .badge.status-Rejected {
        background: #fecaca;
        color: #7f1d1d;
    }

    .doc-section {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: .375rem;
        padding: .75rem .875rem;
        margin-bottom: .75rem;
    }

    .doc-section-title {
        font-size: .95rem;
        font-weight: 600;
        margin-bottom: .35rem;
        display: flex;
        align-items: center;
        gap: .4rem;
    }

    .doc-section-sub {
        font-size: .78rem;
        color: #9ca3af;
        margin-left: .15rem;
    }

    /* ===== 프리뷰 래퍼 (폰트/라인은 eb.doc.preview.css에서 통일 관리) ===== */
    .doc-preview-full {
        padding: 0;
        margin: 0 0 1rem 0;
        border: none;
        background: transparent;
    }

    /* ===== 댓글/로그/승인 ===== */
    .doc-comments-list {
        max-height: 260px;
        overflow-y: auto;
        padding-right: 2px;
        display: flex;
        flex-direction: column;
        gap: .5rem;
        font-size: .86rem;
    }

    .doc-comment-item {
        border-bottom: 1px solid #f3f4f6;
        padding-bottom: .35rem;
    }

    .doc-comment-meta {
        display: flex;
        flex-wrap: wrap;
        gap: .5rem;
        font-size: .78rem;
        color: #9ca3af;
    }

    .doc-comment-body {
        margin-top: .15rem;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .doc-comment-files {
        margin-top: .15rem;
        font-size: .78rem;
    }

    .doc-comment-form textarea {
        width: 100%;
        resize: vertical;
        min-height: 80px;
    }

    #cmt-file-list li {
        display: flex;
        align-items: center;
        gap: .5rem;
    }

    #cmt-file-list button[data-remove] {
        padding: .1rem .4rem;
    }

    .doc-viewlog-list {
        max-height: 160px;
        overflow-y: auto;
        font-size: .8rem;
        white-space: nowrap;
    }

    .doc-approvals-table {
        width: 100%;
        font-size: .8rem;
    }

        .doc-approvals-table th,
        .doc-approvals-table td {
            padding: .25rem .4rem;
            border: 1px solid #e5e7eb;
        }

    .doc-approvals-actions {
        display: flex;
        flex-wrap: wrap;
        gap: .35rem;
        justify-content: flex-end;
        margin-top: .4rem;
    }

    /* ================== 인쇄 전용 ================== */
    @@media print {
        @@page {
            size: A4 portrait;
            margin: 0;
        }

        html, body {
            margin: 0 !important;
            padding: 0 !important;
            background: #fff !important;
        }
            /* 기본적으로 다 숨김 */
            body * {
                visibility: hidden !important;
            }

        .doc-preview-full,
        .doc-preview-full * {
            visibility: visible !important;
        }

        .doc-detail-header,
        .doc-section,
        #detail-alert {
            display: none !important;
        }
        /* 프린트용 래퍼만 보이게 */
        #print-xhost-wrapper,
        #print-xhost-wrapper * {
            visibility: visible !important;
        }

        #print-xhost-wrapper {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            max-width: none !important;
            background: #fff !important;
        }

            #print-xhost-wrapper #xhost {
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                width: 100% !important;
                max-width: none !important;
                background: #fff !important;
                overflow: visible !important;
            }

                #print-xhost-wrapper #xhost .xlfb {
                    display: table !important;
                    table-layout: fixed !important;
                    border-collapse: collapse !important;
                    width: 100% !important;
                    margin: 0 !important;
                    padding: 0 !important;
                    background: #fff !important;
                }

                    #print-xhost-wrapper #xhost .xlfb tr {
                        display: table-row !important;
                    }

                    #print-xhost-wrapper #xhost .xlfb td,
                    #print-xhost-wrapper #xhost .xlfb th {
                        display: table-cell !important;
                        vertical-align: middle !important;
                    }

                    #print-xhost-wrapper #xhost .xlfb,
                    #print-xhost-wrapper #xhost .xlfb * {
                        max-height: none !important;
                        overflow: visible !important;
                    }

        #xhost {
            display: block !important;
            position: static !important;
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
            overflow: visible !important;
            background: #fff !important;
        }

            #xhost .xlfb,
            #xhost .xlfb tr,
            #xhost .xlfb td,
            #xhost .xlfb th {
                page-break-inside: auto !important;
                break-inside: auto !important;
            }
    }
</style>

<div id="doc-scroll">
    <div class="container-xxl doc-detail-root" data-doc-id="@docId">
        <!-- 상단 타이틀 + 메타 + 액션 -->
        <header class="doc-detail-header">
            <div>
                <div class="doc-detail-title">@S["DOC_Title_Detail"]</div>
                <div class="doc-detail-meta">
                    <span><strong>@S["DOC_Label_DocId"]</strong> : <code>@docId</code></span>
                    <span>
                        <strong>@S["_CM_Label_Template"]</strong> :
                        <code>@templateCode</code>
                        <span class="ms-1">@templateTitle</span>
                    </span>
                    <span class="badge status-@status">@S[$"DOC_Status_{status}"]</span>
                </div>
            </div>
            <div class="doc-detail-actions">
                @if (canBackToNew)
                {
                    <a href="/Doc/New" class="btn btn-sm btn-outline-secondary">
                        @S["DOC_Btn_BackToNew"]
                    </a>
                }
                @if (canPrint)
                {
                    <button type="button"
                            class="btn btn-sm btn-outline-primary"
                            id="btnPrint"
                            title="@S["DOC_Btn_Print"]">
                        <i class="bi bi-printer"></i>
                    </button>
                }
                @if (canExport)
                {
                    <button type="button"
                            class="btn btn-sm btn-outline-primary"
                            id="btnExport"
                            title="@S["DOC_Btn_Export"]">
                        <i class="bi bi-file-earmark-pdf"></i>
                    </button>
                }
            </div>
        </header>

        <div id="detail-alert" class="mb-2" aria-live="polite"></div>

        <!-- 1. 문서 프리뷰 -->
        <section class="doc-preview-full" aria-label="Document preview">
            <script type="application/json" id="DescriptorJson">@Html.Raw(descJson)</script>
            <script type="application/json" id="PreviewJson">@Html.Raw(previewJson)</script>
            <script type="application/json" id="InputsJson">@Html.Raw(inputsJson)</script>
            <script type="application/json" id="ViewLogsJson">@Html.Raw(viewLogsJson)</script>
            <script type="application/json" id="ApprovalsJson">@Html.Raw(approvalsJson)</script>

            <!-- Compose와 완전히 동일한 래퍼 구조 -->
            <div id="xlPreview">
                <div id="xhost"></div>
            </div>
        </section>

        <!-- 2. 코멘트 리스트 -->
        <section class="doc-section" aria-labelledby="doc-comments-list-title">
            <div id="doc-comments-list-title" class="doc-section-title">
                @S["_CM_Comment_Label"]
                <span id="cmt-count" class="doc-section-sub"></span>
            </div>
            <div id="cmt-alert" class="mb-1" aria-live="polite"></div>
            <div id="cmt-list" class="doc-comments-list"></div>
        </section>

        <!-- 3. 코멘트 입력 -->
        <section class="doc-section" aria-labelledby="doc-comment-form-title">
            <div id="doc-comment-form-title" class="doc-section-title">
                @S["DOC_Label_AddComment"]
            </div>
            <div class="doc-comment-form">
                <textarea id="cmt-body"
                          class="form-control"
                          rows="3"
                          placeholder="@S["DOC_Placeholder_Comment"]"></textarea>

                <div class="mt-2">
                    <input id="cmt-file" type="file" class="form-control form-control-sm" multiple />
                    <div class="small text-muted mt-1">@S["DOC_File_Help_UploadTypes"]</div>
                    <ul id="cmt-file-list" class="mt-2 mb-0 small"></ul>
                </div>

                <div class="d-flex gap-2 mt-2 justify-content-end">
                    <button id="cmt-submit" type="button" class="btn btn-sm btn-primary">
                        @S["DOC_Btn_CommentPost"]
                    </button>
                </div>
            </div>
        </section>

        <!-- 4. 조회 로그 -->
        <section class="doc-section" aria-labelledby="doc-viewlog-title">
            <div id="doc-viewlog-title" class="doc-section-title">
                @S["DOC_Title_ViewLog"]
            </div>
            <div id="viewlog-list" class="doc-viewlog-list"></div>
        </section>

        <!-- 5. 승인 정보 -->
        <section class="doc-section" aria-labelledby="doc-approvals-title">
            <div id="doc-approvals-title" class="doc-section-title">
                @S["DOC_Label_Approvals"]
                <span class="doc-section-sub">@S["DOC_Help_ApprovalsReadonly"]</span>
            </div>

            <table class="doc-approvals-table">
                <thead>
                    <tr>
                        <th style="width:18%;">@S["DOC_Col_ApproverRole"]</th>
                        <th>@S["DOC_Col_ApproverValue"]</th>
                        <th style="width:12%;">@S["DOC_Col_Status"]</th>
                        <th style="width:18%;">@S["DOC_Col_ApprovalTime"]</th>
                    </tr>
                </thead>
                <tbody id="tbody-approvals"></tbody>
            </table>

            <div class="doc-approvals-actions">
                <button type="button"
                        class="btn btn-sm btn-success"
                        data-approve
                @(canApprove ? "" : "disabled")>
                    @S["DOC_Btn_Approve"]
                </button>
                <button type="button"
                        class="btn btn-sm btn-warning"
                        data-hold
                @(canHold ? "" : "disabled")>
                    @S["DOC_Btn_Hold"]
                </button>
                <button type="button"
                        class="btn btn-sm btn-danger"
                        data-reject
                @(canReject ? "" : "disabled")>
                    @S["DOC_Btn_Reject"]
                </button>
            </div>
        </section>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/eb.doc.preview.css" asp-append-version="true" />
}

@section Scripts {
    <script src="~/js/eb.csrf.js"></script>

    <script>
        // ================== 공통 리소스/유틸 ==================
        function decodeHtmlEntities(str) {
            if (str == null) return '';
            let s = String(str);
            s = s.replace(/&#x([0-9a-fA-F]+);/g, (_, h) => String.fromCodePoint(parseInt(h, 16)));
            s = s.replace(/&#(\d+);/g, (_, d) => String.fromCodePoint(parseInt(d, 10)));
            s = s.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&')
                .replace(/&quot;/g, '"').replace(/&apos;/g, "'");
            return s;
        }

        window.__RESX = {
            DOC_Err_PreviewFailed: "@S["DOC_Err_PreviewFailed"]",
            DOC_Msg_PreviewFallback: "@S["DOC_Msg_PreviewFallback"]",
            DOC_Msg_NoComments: "@S["DOC_Msg_NoComments"]",
            DOC_Msg_NoViewLogs: "@S["DOC_Msg_NoViewLogs"]",
            DOC_Msg_NoApprovals: "@S["DOC_Msg_NoApprovals"]",
            DOC_Msg_CommentCreated: "@S["DOC_Msg_CommentCreated"]",
            DOC_Msg_CommentDeleted: "@S["DOC_Msg_CommentDeleted"]",
            DOC_Err_SaveFailed: "@S["DOC_Err_SaveFailed"]",
            DOC_Err_DeleteFailed: "@S["DOC_Err_DeleteFailed"]",
            DOC_Err_LoadFailed: "@S["DOC_Err_LoadFailed"]",
            DOC_Err_DocumentNotFound: "@S["DOC_Err_DocumentNotFound"]",
            DOC_Msg_Approve_Success: "@S["DOC_Msg_Approve_Success"]",
            DOC_Val_Required: "@S["DOC_Val_Required"]",
            DOC_Cmt_Count: "@S["DOC_Cmt_Count"]",
            DOC_Btn_Reply: "@S["DOC_Btn_Reply"]",
            DOC_Btn_Delete: "@S["DOC_Btn_Delete"]",
            DOC_Placeholder_Reply: "@S["DOC_Placeholder_Reply"]",
            DOC_StatusShort_Pending: "@S["DOC_StatusShort_Pending"]"
        };

        const T = (m) => {
            if (m == null) return '';
            if (Array.isArray(m)) return m.map(T).join('\n');
            const s = String(m);
            const mapped = (window.__RESX && Object.prototype.hasOwnProperty.call(window.__RESX, s))
                ? window.__RESX[s] : s;
            return decodeHtmlEntities(mapped);
        };

        function readJsonFromScript(id, fallback) {
            try {
                const el = document.getElementById(id);
                if (!el) return fallback;
                const raw = el.textContent || '';
                if (!raw.trim()) return fallback;
                let v = JSON.parse(raw);
                if (typeof v === 'string') {
                    try { v = JSON.parse(v); } catch { }
                }
                return (v && typeof v === 'object') ? v : fallback;
            } catch { return fallback; }
        }

        const docId = "@(docId ?? "")";
    </script>

    <script>
        // Detail 화면은 항상 읽기 전용 (공통 프리뷰가 이 플래그를 읽음)
        window.__DOC_IS_WRITE__ = false;
    </script>

    <script src="~/js/eb.doc.preview.common.js"></script>

    <script>
        // ================== 댓글 & 파일 업로드 ==================
        (function initComments() {
            const EBV = window.EBValidate || {};
            const rawFetch = (window.fetch || function () { }).bind(window);

            const EBC = (window.EBCSRF || window.EBCsrf) || {
                async fetch(url, options) {
                    const res = await rawFetch(url, options || {});
                    return res;
                },
                async json(url, payload, method = 'POST') {
                    const res = await rawFetch(url, {
                        method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: method === 'GET' ? undefined : JSON.stringify(payload || {})
                    });
                    const j = await res.json().catch(() => ({}));
                    if (!res.ok) {
                        const err = new Error('request failed');
                        err.payload = j;
                        throw err;
                    }
                    return j;
                }
            };

            const $list = document.getElementById('cmt-list');
            const $alert = document.getElementById('cmt-alert');
            const $count = document.getElementById('cmt-count');
            const $fileIn = document.getElementById('cmt-file');
            const $fileList = document.getElementById('cmt-file-list');
            const $body = document.getElementById('cmt-body');
            const $submit = document.getElementById('cmt-submit');

            const docIdAttr = document.querySelector('.doc-detail-root')?.getAttribute('data-doc-id') || '';

            if (!docIdAttr) {
                showErr([T('DOC_Err_DocumentNotFound')]);
                return;
            }

            let pendingFiles = [];

            $fileIn?.addEventListener('change', () => {
                pendingFiles = Array.from($fileIn.files || []);
                renderFileList();
            });

            $fileList.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-remove]');
                if (!btn) return;
                const idx = Number(btn.getAttribute('data-remove'));
                if (!Number.isNaN(idx)) {
                    pendingFiles.splice(idx, 1);
                    $fileIn.value = '';
                    renderFileList();
                }
            });

            function renderFileList() {
                $fileList.innerHTML = '';
                pendingFiles.forEach((f, i) => {
                    const li = document.createElement('li');
                    li.innerHTML =
                        `<span>${escapeHtml(f.name)}</span>
                                 <span class="text-muted">(${Number(f.size || 0).toLocaleString()})</span>
                                 <button type="button" class="btn btn-outline-secondary btn-sm" data-remove="${i}">&times;</button>`;
                    $fileList.append(li);
                });
            }

            async function loadComments() {
                try {
                    const res = await EBC.fetch('/Doc/Comments?docId=' + encodeURIComponent(docIdAttr), {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    const data = await res.json().catch(() => ({}));
                    const items = Array.isArray(data.items) ? data.items : [];
                    renderComments(items);
                } catch (e) {
                    console.error('loadComments error', e);
                    showErr([T('DOC_Err_LoadFailed')]);
                }
            }

            function renderComments(items) {
                $list.innerHTML = '';
                if (!items.length) {
                    $count.textContent = '';
                    $list.innerHTML = `<div class="text-muted">${T('DOC_Msg_NoComments')}</div>`;
                    return;
                }

                $count.textContent = T('DOC_Cmt_Count').replace('{n}', items.length);

                items.forEach(c => {
                    const wrap = document.createElement('div');
                    wrap.className = 'doc-comment-item';

                    const depth = Math.min(c.depth || 0, 4);
                    if (depth > 0) wrap.style.marginLeft = (depth * 16) + 'px';

                    wrap.innerHTML = `
                                <div class="doc-comment-meta">
                                    <span><strong>${escapeHtml(c.createdBy || '')}</strong></span>
                                    <span>${escapeHtml(c.createdAt || '')}</span>
                                </div>
                                <div class="doc-comment-body">${nl2br(escapeHtml(c.body || ''))}</div>
                            `;

                    $list.append(wrap);
                });
            }

            $submit?.addEventListener('click', async () => {
                const body = ($body.value || '').trim();
                if (!body) {
                    showErr([T('DOC_Val_Required')]);
                    return;
                }

                try {
                    const payload = {
                        docId: docIdAttr,
                        parentCommentId: null,
                        body: body,
                        files: [] // 파일 업로드 후 키 매핑 예정
                    };

                    await EBC.json('/Doc/Comments', payload, 'POST');

                    $body.value = '';
                    pendingFiles = [];
                    if ($fileIn) $fileIn.value = '';
                    renderFileList();

                    $alert.innerHTML = '';
                    await loadComments();
                } catch (e) {
                    console.error('post comment error', e);
                    const p = e && e.payload;
                    showErr(p?.messages || [T('DOC_Err_SaveFailed')]);
                }
            });

            function showErr(msgs) {
                if (EBV.showAlert) {
                    EBV.showAlert('cmt-alert', msgs, { variant: 'danger' });
                } else {
                    $alert.innerHTML =
                        `<div class="alert alert-danger py-1 mb-1">${(msgs || []).map(escapeHtml).join('<br>')}</div>`;
                }
            }

            function escapeHtml(s) {
                return String(s || '').replace(/[&<>"']/g,
                    m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
            }

            function nl2br(s) {
                return String(s || '').replace(/\n/g, '<br>');
            }

            loadComments();
        })();

        // ================== 조회 로그 ==================
        (function renderViewLogs() {
            const host = document.getElementById('viewlog-list');
            if (!host) return;

            const logs = readJsonFromScript('ViewLogsJson', []);

            if (!Array.isArray(logs) || !logs.length) {
                host.innerHTML = `<div class="text-muted">${T('DOC_Msg_NoViewLogs')}</div>`;
                return;
            }

            host.innerHTML = '';
            logs
                .slice()
                .sort((a, b) => (b.viewedAt || '').localeCompare(a.viewedAt || ''))
                .forEach(v => {
                    const row = document.createElement('div');
                    const when = v.viewedAtText || v.viewedAt || '';
                    const who = v.userName || v.userId || '';
                    row.textContent = `${when} - ${who}`;
                    host.append(row);
                });
        })();

        // ================== 승인 정보 ==================
        (function renderApprovals() {
            const tbody = document.getElementById('tbody-approvals');
            if (!tbody) return;

            const list = readJsonFromScript('ApprovalsJson', []);

            if (!Array.isArray(list) || !list.length) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="4" class="text-muted">${T('DOC_Msg_NoApprovals')}</td>`;
                tbody.append(tr);
                return;
            }

            const esc = s => String(s || '').replace(/[&<>"']/g,
                m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));

            list
                .slice()
                .sort((a, b) => (a.step || a.stepOrder || 0) - (b.step || b.stepOrder || 0))
                .forEach(a => {
                    const tr = document.createElement('tr');
                    const role = a.roleKey || a.Part || '';
                    const val = a.approverValue || a.value || a.approverName || '';
                    const st = a.status || a.Action || 'Pending';
                    const when = a.actedAtText || a.actedAt || '';
                    tr.innerHTML = `
                                <td>${esc(role)}</td>
                                <td>${esc(val)}</td>
                                <td>${esc(st)}</td>
                                <td>${esc(when)}</td>`;
                    tbody.append(tr);
                });
        })();

        // ================== 인쇄/Export ==================
        document.getElementById('btnPrint')?.addEventListener('click', () => { window.print(); });
        document.getElementById('btnExport')?.addEventListener('click', () => {
            if (!docId) return;
            const url = '/Doc/ExportPdf?id=' + encodeURIComponent(docId);
            window.location.href = url;
        });

        // ================== 승인 버튼 처리 ==================
        (function initApproveButtons() {
            const EBC = window.EBCSRF || window.EBCsrf || {};
            const alertHost = document.getElementById('detail-alert');
            if (!alertHost || !docId) return;

            function show(msg, cls) {
                alertHost.innerHTML = `<div class="alert ${cls} py-1 my-1">${msg}</div>`;
            }

            async function call(action) {
                try {
                    const res = await (EBC.json
                        ? EBC.json('/Doc/ApproveOrHold', { docId, action }, 'POST')
                        : fetch('/Doc/ApproveOrHold', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                            body: JSON.stringify({ docId, action })
                        }).then(r => r.json()));

                    if (!res || res.ok === false) throw { payload: res };
                    show(T('DOC_Msg_Approve_Success'), 'alert-success');
                    location.reload();
                } catch (e) {
                    const p = e && e.payload;
                    const msgs = p?.messages || [T('DOC_Err_SaveFailed')];
                    show(msgs.join('<br>'), 'alert-danger');
                }
            }

            function bind(selector, action) {
                document.querySelectorAll(selector).forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (btn.disabled) return;
                        call(action);
                    });
                });
            }

            bind('[data-approve]', 'Approve');
            bind('[data-hold]', 'Hold');
            bind('[data-reject]', 'Reject');
        })();

        // ================== 인쇄용 xhost 이동/복원 ==================
        (function () {
            const xhost = document.getElementById('xhost');
            if (!xhost) return;

            const originalParent = xhost.parentNode;
            const originalNext = xhost.nextSibling;
            const printWrapper = document.createElement('div');
            printWrapper.id = 'print-xhost-wrapper';

            function moveToPrintWrapper() {
                if (xhost.parentNode === printWrapper) return;

                if (!printWrapper.parentNode) {
                    document.body.appendChild(printWrapper);
                }

                printWrapper.appendChild(xhost);
            }

            function restoreFromPrintWrapper() {
                if (!originalParent) return;

                if (originalNext && originalNext.parentNode === originalParent) {
                    originalParent.insertBefore(xhost, originalNext);
                } else {
                    originalParent.appendChild(xhost);
                }

                if (printWrapper.parentNode) {
                    printWrapper.parentNode.removeChild(printWrapper);
                }
            }

            function handleBeforePrint() { moveToPrintWrapper(); }
            function handleAfterPrint() { restoreFromPrintWrapper(); }

            if (window.matchMedia) {
                const mq = window.matchMedia('print');
                mq.addEventListener('change', function (e) {
                    if (e.matches) handleBeforePrint(); else handleAfterPrint();
                });
            }

            window.addEventListener('beforeprint', handleBeforePrint);
            window.addEventListener('afterprint', handleAfterPrint);
        })();
    </script>
}
