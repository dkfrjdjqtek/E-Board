@* 2025.11.13 Changed: eb.doc.preview.common.js 공통 스크립트 사용하도록 Compose 화면 스크립트 분리 *@
@* 2025.11.11 Changed: 포커스 링 단일화 및 활성 그룹 기준 재계산 (비고 영역에 고정되던 문제 수정) *@
@* 2025.11.04 Changed: 메일 전송 요청 body 구성과 CSRF 토큰 적용 저장 응답 처리 보강 기타 로직 변경 없음 *@
@model WebApplication1.Models.DocTLViewModel
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> S
@{
    ViewData["Title"] = S["DOC_Title_Compose"];
    var templateCode = (string?)ViewBag.TemplateCode
                        ?? (Context?.Request?.Query["templateCode"].ToString() ?? string.Empty);
    var templateTitle = (string?)ViewBag.TemplateTitle ?? string.Empty;
    var descJson = (string?)ViewBag.DescriptorJson ?? "{}";
    var previewJson = (string?)ViewBag.PreviewJson ?? "{}";
}
<style>
    html, body {
        height: 100%;
        overflow: hidden !important;
        background: #fff;
        margin: 0;
    }

    #doc-scroll {
        position: fixed;
        inset: 0;
        overflow-y: auto !important;
        overflow-x: auto !important;
        box-sizing: border-box;
        background: #fff;
        z-index: 1;
        scrollbar-gutter: stable both-edges;
        padding-bottom: 0;
    }

    .doc-unclip {
        overflow: visible !important;
        max-width: none !important;
        transform: none !important;
        will-change: auto !important;
        filter: none !important;
    }

    .page-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        margin: 0;
    }
    .page-header h3 { margin: 0; }

    .form-actions {
        margin: 16px;
        padding: 12px 0;
        border-top: 1px solid #e9ecef;
        display: flex;
        gap: 8px;
        max-width: 100%;
    }

    .action-btn { width: 140px; height: 36px; white-space: nowrap; }

    @Html.Raw("@media print{#doc-scroll{overflow:visible;position:static;inset:auto;height:auto;padding:0}.form-actions{display:none}}")

    /* 디버그용 간단 모달 */
    .eb-modal-mask {
        position: fixed; inset: 0; background: rgba(0,0,0,.35);
        z-index: 2000; display: flex; align-items: center; justify-content: center;
    }
    .eb-modal {
        background: #fff; width: min(920px,96vw); max-height: 86vh;
        border-radius: 8px; box-shadow: 0 14px 48px rgba(0,0,0,.25);
        display: flex; flex-direction: column;
    }
    .eb-modal header {
        padding: 10px 14px; border-bottom: 1px solid #e5e7eb;
        display: flex; justify-content: space-between; align-items: center
    }
    .eb-modal .body { padding: 0; overflow: auto }
    .eb-modal pre { margin: 0; padding: 12px 14px; font-size: .86rem }
    .eb-modal footer {
        padding: 10px 14px; border-top: 1px solid #e5e7eb;
        display: flex; gap: 8px; justify-content: flex-end
    }

    .btn {
        display: inline-flex; align-items: center; justify-content: center;
        height: 36px; padding: 0 14px; border-radius: 8px;
        border: 1px solid transparent; cursor: pointer;
    }
    .btn-primary { background: #0d6efd; color: #fff }
    .btn-outline { background: #fff; border-color: #cbd5e1; color: #111827 }
</style>

<div id="doc-scroll" data-template-code="@templateCode">
    <div class="page-header">
        <h3>@S["DOC_Title_Compose"]</h3>
        <span class="text-muted">@templateTitle</span>
    </div>
    <div id="doc-alert" class="mb-2" aria-live="polite"></div>

    <form id="doc-form" method="post" asp-controller="Doc" asp-action="Create" novalidate style="max-width:100%">
        <input type="hidden" name="TemplateCode" value="@templateCode" />
        <input type="hidden" name="templateCode" value="@templateCode" />

        <script type="application/json" id="DescriptorJson">@Html.Raw(descJson)</script>
        <script type="application/json" id="PreviewJson">@Html.Raw(previewJson)</script>

        <script>
            window.__RESX = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(new
                {
                    DOC_Err_PreviewFailed = S["DOC_Err_PreviewFailed"].Value,
                    DOC_Err_SaveFailed = S["DOC_Err_SaveFailed"].Value,
                    DOC_Msg_Saved = S["DOC_Msg_Saved"].Value,
                    DOC_Val_TemplateRequired = S["DOC_Val_TemplateRequired"].Value,
                    DOC_Btn_Cancel = S["DOC_Btn_Cancel"].Value,
                    DOC_Submit_Button = S["DOC_Submit_Button"].Value
                }));
            window.__tplFromServer = "@templateCode";
        </script>

        <div id="xlPreview"><div id="xhost"></div></div>

        <div class="form-actions">
            <button type="button" id="btn-save" class="btn btn-primary action-btn" data-doc-submit>
                @S["DOC_Submit_Button"]
            </button>
            <button type="button" id="btn-cancel" class="btn btn-outline-secondary action-btn">
                @S["DOC_Btn_Cancel"]
            </button>
        </div>
    </form>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/eb.doc.preview.css" asp-append-version="true" />
}

@section Scripts {
    <script src="~/js/eb.csrf.js"></script>
    <script src="~/js/eb.doc.preview.common.js"></script>
}
