@* 2026.01.12 Changed: 빌드 정보는 Program 어셈블리에서 읽고 yyyyMMdd.HHmm (7자리해시) 형식으로만 강제 표시 *@
@* 2025.09.17 Changed: 필드 하단 문구가 "중복" 출력되는 원인 제거(asp-validation-for + EBValidate 이중 렌더링 해소) *@
@* 2025.09.17 Changed: 제출(로그인 클릭) 전까지 invalid 보더/아이콘 고정 – 입력·포커스로는 상태 변경 금지 유지 *@
@* 2025.09.16 Changed: 서버 ModelState를 EBValidate로 렌더링하도록 변경. 요약은 _ValidationAlert 사용. *@

@using System.Linq
@using System.Text.Json
@using System.Reflection
@using System.Text.RegularExpressions
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> S
@model WebApplication1.Models.LoginViewModel

@{
    ViewData["Title"] = S["Login_Title"];

    // 서버 ModelState → { 키: [메시지] }
    var errMap = ViewData.ModelState
        .Where(kv => kv.Value?.Errors?.Count > 0)
        .ToDictionary(
            kv => kv.Key,
            kv => kv.Value!.Errors.Select(e => e.ErrorMessage).ToArray()
        );

    // 요약 메시지
    var serverErrors = errMap.Values.SelectMany(v => v).ToArray();

    // ------------------------------------------------------------
    // 2026.01.12 Changed:
    // 화면 출력은 반드시 "yyyyMMdd.HHmm (7자리해시)" 한 가지 형식만.
    // - Version(1.0.0) 출력 안 함
    // - Environment(Development) 출력 안 함
    // - Razor 런타임 컴파일 어셈블리(ExecutingAssembly) 금지 → Program 어셈블리 고정
    // - 뒤에 자동으로 붙는 잡다한 문자열은 전부 무시
    // ------------------------------------------------------------
    var infoVerRaw =
        typeof(Program).Assembly
            .GetCustomAttribute<AssemblyInformationalVersionAttribute>()?
            .InformationalVersion
        ?? "";

    // 날짜/시간: "yyyyMMdd.HHmm" 우선 매칭 (예: 20260112.1727)
    // (참고) 현재 csproj가 git count로 찍는 형식(yyyyMMdd.####)이면 여기서 HHmm을 만들 수 없으므로, HHmm이 포함되도록 csproj도 맞춰야 합니다.
    var mDt = Regex.Match(infoVerRaw, @"\b(?<d>\d{8})\.(?<t>\d{4})\b");
    var d = mDt.Success ? mDt.Groups["d"].Value : "";
    var t = mDt.Success ? mDt.Groups["t"].Value : "";

    // 해시: 괄호 안이 있으면 우선 사용 (4~40 자리 가능). 없으면 전체 문자열에서 7자리 hex를 탐색.
    var mhParen = Regex.Match(infoVerRaw, @"\((?<h>[0-9a-fA-F]{4,40})\)");
    var hRaw = mhParen.Success ? mhParen.Groups["h"].Value : "";

    if (string.IsNullOrWhiteSpace(hRaw))
    {
        var mhAny = Regex.Match(infoVerRaw, @"\b(?<h>[0-9a-fA-F]{7,40})\b");
        hRaw = mhAny.Success ? mhAny.Groups["h"].Value : "";
    }

    // 7자리 해시로 강제(길이가 7보다 길면 앞 7자리 사용)
    var h7 = "";
    if (!string.IsNullOrWhiteSpace(hRaw))
        h7 = (hRaw.Length >= 7) ? hRaw.Substring(0, 7) : hRaw;

    var buildText =
        (!string.IsNullOrWhiteSpace(d) && !string.IsNullOrWhiteSpace(t) && !string.IsNullOrWhiteSpace(h7))
            ? $"{d}.{t} ({h7})"
            : "";
}

<h1>@S["Login_Login"]</h1>

@* 상단 요약 알림 (id=login-alert) *@
@await Html.PartialAsync(
                "~/Views/Shared/_ValidationAlert.cshtml",
                serverErrors,
                new ViewDataDictionary(ViewData) { ["AlertId"] = "login-alert" }
            )

<form asp-action="Login" method="post" novalidate id="login-form">
    @Html.AntiForgeryToken()
    <input type="hidden" name="returnUrl" value="@ViewData["ReturnUrl"]" />

    <div class="mb-3">
        <label asp-for="UserName" class="form-label"></label>
        <input asp-for="UserName" class="form-control" autocomplete="username"
               placeholder="@S["Login_UserName_Placeholder"]" />
        @* 2025.09.17 Added: 클라이언트 Required 표적 *@
        <span asp-validation-for="UserName" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Password" class="form-label"></label>
        <input asp-for="Password" class="form-control" autocomplete="current-password"
               placeholder="@S["Login_Password_Placeholder"]" />
        @* 2025.09.17 Added: 클라이언트 Required 표적 *@
        <span asp-validation-for="Password" class="text-danger"></span>
    </div>

    <div class="form-check mb-3">
        <input asp-for="RememberMe" class="form-check-input" />
        <label asp-for="RememberMe" class="form-check-label"></label>
    </div>

    <div class="row g-2 mt-3">
        <div class="col-12 col-md-8">
            <button type="submit" class="btn btn-primary w-100 py-2">@S["Header_LogIn"]</button>
        </div>
        <div class="col-12 col-md-4">
            <a asp-area="Identity" asp-page="/Account/ForgotPassword" class="btn btn-warning w-100 py-2" role="button">
                @S["Login_ForgotPassword"]
            </a>
        </div>
    </div>
</form>

@* 2026.01.12 Changed: 빌드 정보는 요청 형식으로만 출력 *@
@if (!string.IsNullOrWhiteSpace(buildText))
{
    <div class="text-muted small mt-3" aria-label="@S["Login_BuildInfo_Aria"]">
        @S["Login_BuildInfo_Format", buildText]
    </div>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // 2025.09.16 Added: 서버 ModelState JSON
        window.__LOGIN_ERRMAP__ = @Html.Raw(JsonSerializer.Serialize(errMap));

        (function () {
            const map = window.__LOGIN_ERRMAP__ || {};

            // 2025.09.17 Changed: 서버 에러 요약만 EBValidate로 초기 표출(필드 하단 문구는 asp-validation-for가 담당)
            const all = Object.values(map).flat();
            if (all.length && window.EBValidate) {
                EBValidate.showAlert('login-alert', all);
            }
        })();

        // 2025.09.17 Changed: 제출 시에만 클라이언트 검증 수행 + 요약 1회 갱신
        (function () {
            var form = document.getElementById('login-form');
            if (!form || !window.jQuery) return;

            // unobtrusive 파싱 보장
            try {
                jQuery(form).removeData('validator').removeData('unobtrusiveValidation');
                if (jQuery.validator?.unobtrusive?.parse) jQuery.validator.unobtrusive.parse(form);
            } catch (e) { /* 2025.09.17 Added: 무시 */ }

            var v = jQuery(form).data('validator');
            if (v) {
                // 포커스/키입력으로 재검증하지 않음 → 붉은 보더/아이콘 고정
                v.settings.onkeyup = false;
                v.settings.onfocusout = false;
                v.settings.onclick = false;
            }

            function updateSummaryOnce() {
                var msgs = [];
                var validator = jQuery(form).data('validator');
                if (validator?.errorList?.length) {
                    for (var i = 0; i < validator.errorList.length; i++) {
                        var m = validator.errorList[i]?.message;
                        if (m) msgs.push(m);
                    }
                }
                if (window.EBValidate) EBValidate.showAlert('login-alert', msgs);
            }

            // 2025.09.17 Changed: 제출 실패시에만 요약 갱신
            jQuery(form).on('invalid-form.validate', function () {
                updateSummaryOnce();
                // 2025.09.17 Removed: 여기서 EBValidate.setInvalid(필드별) 호출하지 않음
                // 이유: asp-validation-for가 이미 문구를 렌더 → 중복 방지
            });
        })();
    </script>
}
